<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å¿—æŸ¥çœ‹å™¨</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--vscode-editor-background);
            color: var(--vscode-editor-foreground);
            padding: 10px;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .toolbar {
            background-color: var(--vscode-editorWidget-background);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
            flex-wrap: wrap;
        }
        
        .file-info {
            font-size: 12px;
            color: var(--vscode-descriptionForeground);
            flex: 1;
            min-width: 200px;
        }
        
        .search-box {
            display: flex;
            gap: 5px;
            flex: 1;
            min-width: 100%;
            flex-wrap: wrap;
            align-items: center;
        }
        
        input[type="text"] {
            flex: 1;
            min-width: 200px;
            padding: 5px 10px;
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            border-radius: 3px;
            font-size: 12px;
        }
        
        button {
            padding: 5px 12px;
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: var(--vscode-button-hoverBackground);
        }
        
        .log-container {
            flex: 1;
            overflow-y: auto;
            background-color: var(--vscode-editor-background);
            border: 1px solid var(--vscode-panel-border);
            border-radius: 5px;
            padding: 10px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
        }
        
        .log-line {
            padding: 2px 0;
            border-bottom: 1px solid var(--vscode-panel-border);
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .log-line:hover {
            background-color: var(--vscode-list-hoverBackground);
        }
        
        .log-line-number {
            display: inline-block;
            width: 60px;
            color: var(--vscode-editorLineNumber-foreground);
            user-select: none;
            text-align: right;
            padding-right: 10px;
        }
        
        .log-line-content {
            display: inline;
        }
        
        .highlight {
            background-color: var(--vscode-editor-findMatchHighlightBackground);
            color: var(--vscode-editor-findMatchHighlightForeground);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--vscode-descriptionForeground);
        }
        
        .stats {
            font-size: 11px;
            color: var(--vscode-descriptionForeground);
        }
        
        .filter-panel {
            background-color: var(--vscode-editorWidget-background);
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        /* æ—¶é—´çº¿é¢æ¿æ ·å¼ */
        .timeline-panel {
            background-color: var(--vscode-editorWidget-background);
            border-radius: 5px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .timeline-header {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: background-color 0.2s;
        }
        
        .timeline-header:hover {
            background-color: var(--vscode-list-hoverBackground);
        }
        
        .timeline-content {
            padding: 10px;
            border-top: 1px solid var(--vscode-panel-border);
        }
        
        #timelineCanvas {
            width: 100%;
            height: 80px;
            cursor: pointer;
        }
        
        .checkbox-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .checkbox-group input[type="checkbox"] {
            cursor: pointer;
        }
        
        .log-line.error {
            border-left: 3px solid #f14c4c;
            padding-left: 5px;
        }
        
        .log-line.warn {
            border-left: 3px solid #cca700;
            padding-left: 5px;
        }
        
        .log-line.info {
            border-left: 3px solid #4fc1ff;
            padding-left: 5px;
        }
        
        .log-line.debug {
            border-left: 3px solid #b267e6;
            padding-left: 5px;
        }
        
        .log-line.highlight-target {
            background-color: rgba(255, 193, 7, 0.3);
            border-left: 3px solid #ffc107;
            animation: highlight-pulse 0.5s ease-in-out;
        }
        
        @keyframes highlight-pulse {
            0%, 100% { background-color: rgba(255, 193, 7, 0.3); }
            50% { background-color: rgba(255, 193, 7, 0.6); }
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
        
        /* å³é”®èœå•æ ·å¼ */
        .context-menu {
            position: fixed;
            background-color: var(--vscode-menu-background);
            border: 1px solid var(--vscode-menu-border);
            border-radius: 3px;
            padding: 4px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            min-width: 180px;
        }
        
        .context-menu-item {
            padding: 6px 16px;
            cursor: pointer;
            font-size: 13px;
            color: var(--vscode-menu-foreground);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .context-menu-item:hover {
            background-color: var(--vscode-menu-selectionBackground);
            color: var(--vscode-menu-selectionForeground);
        }
        
        .context-menu-separator {
            height: 1px;
            background-color: var(--vscode-menu-separatorBackground);
            margin: 4px 0;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: var(--vscode-editor-background);
            margin: 5% auto;
            border: 1px solid var(--vscode-panel-border);
            border-radius: 5px;
            width: 80%;
            max-width: 900px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--vscode-panel-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 18px;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
        }
        
        .modal-close {
            color: var(--vscode-foreground);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .stats-card {
            background-color: var(--vscode-editorWidget-background);
            padding: 15px;
            border-radius: 5px;
            border: 1px solid var(--vscode-panel-border);
        }
        
        .stats-card h3 {
            font-size: 14px;
            margin-bottom: 5px;
            color: var(--vscode-descriptionForeground);
        }
        
        .stats-card .value {
            font-size: 24px;
            font-weight: bold;
            color: var(--vscode-foreground);
        }
        
        /* åˆ†é¡µæ ·å¼ */
        .pagination {
            background-color: var(--vscode-editorWidget-background);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .pagination button {
            min-width: 35px;
            padding: 5px 10px;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination .page-info {
            font-size: 13px;
            color: var(--vscode-descriptionForeground);
            margin: 0 10px;
            font-weight: 500;
        }
        
        .pagination input[type="number"] {
            width: 60px;
            padding: 3px 5px;
            text-align: center;
        }
        
        .pagination select {
            padding: 6px 8px;
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }
        
        .pagination select option {
            background-color: var(--vscode-dropdown-background);
            color: var(--vscode-dropdown-foreground);
            padding: 5px;
        }
        
        /* å¢å¼ºé«˜äº®æ ·å¼ */
        .highlight {
            background-color: #fbbf24;
            color: #000;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: bold;
        }
        
        .highlight-error {
            background-color: #f14c4c;
            color: #fff;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: bold;
        }
        
        .highlight-warn {
            background-color: #cca700;
            color: #fff;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: bold;
        }
        
        .highlight-info {
            background-color: #4fc1ff;
            color: #000;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: bold;
        }
        
        .highlight-time {
            background-color: #b267e6;
            color: #fff;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: bold;
        }
        
        /* é€šç”¨ select å’Œ option æ ·å¼ */
        select {
            background-color: var(--vscode-dropdown-background);
            color: var(--vscode-dropdown-foreground);
            border: 1px solid var(--vscode-dropdown-border);
            border-radius: 3px;
            cursor: pointer;
        }
        
        select option {
            background-color: var(--vscode-dropdown-background);
            color: var(--vscode-dropdown-foreground);
            padding: 5px;
        }
        
        /* æ³¨é‡Šæ ·å¼ */
        .comment-badge {
            display: inline-block;
            background-color: #10b981;
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 5px;
            cursor: pointer;
            user-select: none;
        }
        
        .comment-badge:hover {
            background-color: #059669;
        }
        
        .log-comment {
            display: block;
            background-color: rgba(16, 185, 129, 0.1);
            border-left: 3px solid #10b981;
            padding: 5px 10px;
            margin-top: 3px;
            font-size: 11px;
            font-style: italic;
            color: var(--vscode-descriptionForeground);
        }
        
        /* JSON/XML æ ‘çŠ¶ç»“æ„æ ·å¼ */
        .json-tree, .xml-tree {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.6;
            margin: 5px 0;
            padding: 8px;
            background-color: rgba(107, 114, 128, 0.05);
            border-radius: 4px;
            border-left: 3px solid #8b5cf6;
        }
        
        .json-tree-item, .xml-tree-item {
            margin-left: 15px;
            position: relative;
        }
        
        .json-tree-toggle, .xml-tree-toggle {
            display: inline-block;
            width: 14px;
            height: 14px;
            cursor: pointer;
            user-select: none;
            margin-right: 4px;
            color: var(--vscode-textLink-foreground);
            font-weight: bold;
            vertical-align: middle;
        }
        
        .json-tree-toggle:hover, .xml-tree-toggle:hover {
            background-color: var(--vscode-list-hoverBackground);
            border-radius: 2px;
        }
        
        .json-key {
            color: #9cdcfe;
            font-weight: 500;
        }
        
        .json-string {
            color: #ce9178;
        }
        
        .json-number {
            color: #b5cea8;
        }
        
        .json-boolean {
            color: #569cd6;
            font-weight: bold;
        }
        
        .json-null {
            color: #808080;
            font-style: italic;
        }
        
        .xml-tag {
            color: #4ec9b0;
        }
        
        .xml-attr-name {
            color: #9cdcfe;
        }
        
        .xml-attr-value {
            color: #ce9178;
        }
        
        .json-tree-collapsed, .xml-tree-collapsed {
            display: none;
        }
        
        .json-expand-btn {
            display: inline-block;
            margin-left: 5px;
            padding: 2px 6px;
            font-size: 10px;
            background-color: #8b5cf6;
            color: white;
            border-radius: 3px;
            cursor: pointer;
            user-select: none;
        }
        
        .json-expand-btn:hover {
            background-color: #7c3aed;
        }
        

    </style>
</head>
<body>
    <div class="toolbar">
        <div class="file-info">
            <div><strong>æ–‡ä»¶:</strong> <span id="fileName">æœªåŠ è½½</span></div>
            <div class="stats">
                <span><strong>å¤§å°:</strong> <span id="fileSize">0</span>MB</span>
                <span style="margin-left: 15px;"><strong>æ€»è¡Œæ•°:</strong> <span id="totalLines">0</span></span>
                <span style="margin-left: 15px;"><strong>å·²åŠ è½½:</strong> <span id="loadedLines">0</span></span>
            </div>
        </div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="æœç´¢æ—¥å¿—å†…å®¹...">
            <label style="font-size: 12px; display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" id="regexMode">
                <span>æ­£åˆ™</span>
            </label>
            <label style="font-size: 12px; display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" id="reverseMode">
                <span>åå‘æœç´¢</span>
            </label>
            <button onclick="search()">ğŸ” æœç´¢</button>
            <button onclick="showAdvancedSearchModal()" style="background-color: #0e7490;">ğŸ” é«˜çº§æœç´¢</button>
            <button onclick="showJumpDialog()" style="background-color: #0e7490;">ğŸ¯ å®šä½</button>
            <button onclick="showBookmarksModal()" style="background-color: #7c3aed;">ğŸ“Œ ä¹¦ç­¾</button>
            <button onclick="showCommentsModal()" style="background-color: #10b981;">ğŸ“ æ³¨é‡Š</button>
            <button onclick="showStats()">ğŸ“ˆ ç»Ÿè®¡</button>
            <button onclick="exportLogs()">ğŸ’¾ å¯¼å‡º</button>
            <button onclick="showDeleteModal()" style="background-color: #dc2626;">ğŸ—‘ï¸ åˆ é™¤</button>
            <button onclick="refresh()">ğŸ”„ åˆ·æ–°</button>
        </div>
    </div>
    
    <div class="filter-panel">
        <span style="font-size: 12px; font-weight: bold;">æ—¥å¿—çº§åˆ«:</span>
        <div class="checkbox-group">
            <label style="font-weight: bold; color: var(--vscode-button-background);">
                <input type="checkbox" id="filterAll" checked onchange="toggleAll()">
                <span>âœ”ï¸ å…¨é€‰</span>
            </label>
            <span style="width: 1px; height: 20px; background-color: var(--vscode-panel-border); margin: 0 5px;"></span>
            <label>
                <input type="checkbox" id="filterError" checked onchange="applyFilter()">
                <span style="color: #f14c4c; font-weight: bold;">â– </span> ERROR
            </label>
            <label>
                <input type="checkbox" id="filterWarn" checked onchange="applyFilter()">
                <span style="color: #cca700; font-weight: bold;">â– </span> WARN
            </label>
            <label>
                <input type="checkbox" id="filterInfo" checked onchange="applyFilter()">
                <span style="color: #4fc1ff; font-weight: bold;">â– </span> INFO
            </label>
            <label>
                <input type="checkbox" id="filterDebug" checked onchange="applyFilter()">
                <span style="color: #b267e6; font-weight: bold;">â– </span> DEBUG
            </label>
            <label><input type="checkbox" id="filterOther" checked onchange="applyFilter()"> å…¶ä»–</label>
        </div>
        <button onclick="showLegendModal()" style="margin-left: auto; padding: 3px 10px; font-size: 12px;">ğŸ¨ é¢œè‰²å›¾ä¾‹</button>
    </div>
    
    <!-- æ—¶é—´çº¿å¯¼èˆª -->
    <div class="timeline-panel" id="timelinePanel" style="display: none;">
        <div class="timeline-header" onclick="toggleTimeline()">
            <span style="font-weight: bold; font-size: 12px;">ğŸ“ˆ æ—¶é—´çº¿å¯¼èˆª</span>
            <span id="timelineToggleIcon" style="font-size: 12px;">â–¼</span>
        </div>
        <div class="timeline-content" id="timelineContent">
            <canvas id="timelineCanvas" width="100%" height="80"></canvas>
            <div id="timelineInfo" style="font-size: 11px; color: var(--vscode-descriptionForeground); margin-top: 5px; text-align: center;">
                <!-- æ—¶é—´èŒƒå›´ä¿¡æ¯ -->
            </div>
        </div>
    </div>
    
    <div class="log-container" id="logContainer">
        <div class="loading">ç­‰å¾…åŠ è½½æ—¥å¿—æ–‡ä»¶...</div>
    </div>
    
    <!-- åˆ†é¡µæ§ä»¶ -->
    <div class="pagination" id="pagination" style="display: none;">
        <button onclick="goToFirstPage()" id="firstPageBtn">â®ï¸ é¦–é¡µ</button>
        <button onclick="goToPrevPage()" id="prevPageBtn">â—€ï¸ ä¸Šä¸€é¡µ</button>
        <span class="page-info">
            ç¬¬ <input type="number" id="currentPageInput" min="1" value="1" onchange="goToPage(this.value)"> 
            / <span id="totalPages">1</span> é¡µ
        </span>
        <button onclick="goToNextPage()" id="nextPageBtn">ä¸‹ä¸€é¡µ â–¶ï¸</button>
        <button onclick="goToLastPage()" id="lastPageBtn">æœ«é¡µ â­ï¸</button>
        <span class="page-info" style="margin-left: 20px;">
            <span style="font-size: 14px; font-weight: 600;">æ¯é¡µæ˜¾ç¤ºï¼š</span>
            <select id="pageSizeSelect" onchange="changePageSize(this.value)">
                <option value="50">50</option>
                <option value="100" selected>100</option>
                <option value="200">200</option>
                <option value="500">500</option>
                <option value="1000">1000</option>
            </select>
            <span style="font-size: 14px; font-weight: 600;">è¡Œ</span>
        </span>
        <span class="page-info">
            å…± <span id="totalLinesInPage">0</span> è¡Œ
        </span>
    </div>
    
    <!-- ç»Ÿè®¡å¼¹çª— -->
    <div id="statsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ—¥å¿—ç»Ÿè®¡ä¿¡æ¯</h2>
                <span class="modal-close" onclick="closeStatsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="stats-grid" id="statsGrid">
                    <!-- ç»Ÿè®¡ä¿¡æ¯å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- æŒ‰æ—¶é—´åˆ é™¤å¼¹çª— -->
    <div id="deleteByTimeModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeDeleteByTimeModal()">&times;</span>
            <h2>â° æŒ‰æ—¶é—´åˆ é™¤æ—¥å¿—</h2>
            <div style="margin-top: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">åˆ é™¤æ¨¡å¼ï¼š</label>
                    <select id="deleteTimeMode" style="width: 100%; padding: 8px; background-color: var(--vscode-input-background); color: var(--vscode-input-foreground); border: 1px solid var(--vscode-input-border); border-radius: 3px;">
                        <option value="before">åˆ é™¤æŒ‡å®šæ—¶é—´ä¹‹å‰çš„æ—¥å¿—</option>
                        <option value="after">åˆ é™¤æŒ‡å®šæ—¶é—´ä¹‹åçš„æ—¥å¿—</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ—¶é—´ï¼ˆæ”¯æŒæ ¼å¼ï¼š2024-01-01 12:00:00 æˆ– 2024-01-01ï¼‰ï¼š</label>
                    <input type="text" id="deleteTimeInput" placeholder="ä¾‹å¦‚ï¼š2024-01-01 12:00:00" style="width: 100%; padding: 8px; background-color: var(--vscode-input-background); color: var(--vscode-input-foreground); border: 1px solid var(--vscode-input-border); border-radius: 3px;">
                </div>
                <div style="background-color: var(--vscode-editorWidget-background); padding: 10px; border-radius: 3px; margin-bottom: 15px; border-left: 3px solid #d97706;">
                    <strong>âš ï¸ è­¦å‘Šï¼š</strong>æ­¤æ“ä½œä¼šç›´æ¥ä¿®æ”¹åŸæ–‡ä»¶ï¼Œä¸å¯æ¢å¤ï¼è¯·åŠ¡å¿…å¤‡ä»½é‡è¦æ—¥å¿—ï¼
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="closeDeleteByTimeModal()">å–æ¶ˆ</button>
                    <button onclick="confirmDeleteByTime()" style="background-color: #d97706;">ç¡®è®¤åˆ é™¤</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åˆ é™¤æ–¹å¼é€‰æ‹©å¼¹çª— -->
    <div id="deleteModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>ğŸ—‘ï¸ åˆ é™¤æ—¥å¿—</h2>
                <span class="modal-close" onclick="closeDeleteModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 15px;">
                    <button onclick="selectDeleteByTime()" style="padding: 15px; background-color: #d97706; display: flex; align-items: center; gap: 10px; font-size: 14px;">
                        <span style="font-size: 20px;">â°</span>
                        <div style="text-align: left;">
                            <div style="font-weight: bold;">æŒ‰æ—¶é—´åˆ é™¤</div>
                            <div style="font-size: 11px; opacity: 0.9; margin-top: 3px;">åˆ é™¤æŒ‡å®šæ—¶é—´ä¹‹å‰/ä¹‹åçš„æ—¥å¿—</div>
                        </div>
                    </button>
                    <button onclick="selectDeleteByLine()" style="padding: 15px; background-color: #dc2626; display: flex; align-items: center; gap: 10px; font-size: 14px;">
                        <span style="font-size: 20px;">ğŸ“Š</span>
                        <div style="text-align: left;">
                            <div style="font-weight: bold;">æŒ‰è¡Œæ•°åˆ é™¤</div>
                            <div style="font-size: 11px; opacity: 0.9; margin-top: 3px;">åˆ é™¤æŒ‡å®šè¡Œä¹‹å‰/ä¹‹åçš„æ—¥å¿—</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æŒ‰è¡Œæ•°åˆ é™¤å¼¹çª— -->
    <div id="deleteByLineModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeDeleteByLineModal()">&times;</span>
            <h2>ğŸ“Š æŒ‰è¡Œæ•°åˆ é™¤æ—¥å¿—</h2>
            <div style="margin-top: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">åˆ é™¤æ¨¡å¼ï¼š</label>
                    <select id="deleteLineMode" style="width: 100%; padding: 8px; background-color: var(--vscode-input-background); color: var(--vscode-input-foreground); border: 1px solid var(--vscode-input-border); border-radius: 3px;">
                        <option value="before">åˆ é™¤æŒ‡å®šè¡Œä¹‹å‰çš„æ—¥å¿—</option>
                        <option value="after">åˆ é™¤æŒ‡å®šè¡Œä¹‹åçš„æ—¥å¿—</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">è¡Œå·ï¼ˆä»1å¼€å§‹ï¼‰ï¼š</label>
                    <input type="number" id="deleteLineInput" placeholder="ä¾‹å¦‚ï¼š1000" min="1" style="width: 100%; padding: 8px; background-color: var(--vscode-input-background); color: var(--vscode-input-foreground); border: 1px solid var(--vscode-input-border); border-radius: 3px;">
                </div>
                <div style="background-color: var(--vscode-editorWidget-background); padding: 10px; border-radius: 3px; margin-bottom: 15px; border-left: 3px solid #dc2626;">
                    <strong>âš ï¸ è­¦å‘Šï¼š</strong>æ­¤æ“ä½œä¼šç›´æ¥ä¿®æ”¹åŸæ–‡ä»¶ï¼Œä¸å¯æ¢å¤ï¼è¯·åŠ¡å¿…å¤‡ä»½é‡è¦æ—¥å¿—ï¼
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="closeDeleteByLineModal()">å–æ¶ˆ</button>
                    <button onclick="confirmDeleteByLine()" style="background-color: #dc2626;">ç¡®è®¤åˆ é™¤</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å¿«é€Ÿå®šä½å¼¹çª— -->
    <div id="jumpModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>ğŸ¯ å¿«é€Ÿå®šä½</h2>
                <span class="modal-close" onclick="closeJumpModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">å®šä½æ–¹å¼ï¼š</label>
                    <select id="jumpMode" onchange="switchJumpMode()" style="width: 100%; padding: 8px; background-color: var(--vscode-input-background); color: var(--vscode-input-foreground); border: 1px solid var(--vscode-input-border); border-radius: 3px; font-size: 13px;">
                        <option value="line">ğŸ“ æŒ‰è¡Œå·å®šä½</option>
                        <option value="time">â° æŒ‰æ—¶é—´å®šä½</option>
                    </select>
                </div>
                <div id="jumpByLineSection">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">è¡Œå·ï¼ˆä»1å¼€å§‹ï¼‰ï¼š</label>
                        <input type="number" id="jumpLineInput" placeholder="ä¾‹å¦‚ï¼š1000" min="1" style="width: 100%; padding: 8px; background-color: var(--vscode-input-background); color: var(--vscode-input-foreground); border: 1px solid var(--vscode-input-border); border-radius: 3px;">
                    </div>
                </div>
                <div id="jumpByTimeSection" style="display: none;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ—¶é—´ï¼ˆæ”¯æŒæ ¼å¼ï¼š2024-01-01 12:00:00 æˆ– 2024-01-01ï¼‰ï¼š</label>
                        <input type="text" id="jumpTimeInput" placeholder="ä¾‹å¦‚ï¼š2025-11-14 09:00:00" style="width: 100%; padding: 8px; background-color: var(--vscode-input-background); color: var(--vscode-input-foreground); border: 1px solid var(--vscode-input-border); border-radius: 3px;">
                    </div>
                </div>
                <div style="background-color: var(--vscode-editorWidget-background); padding: 10px; border-radius: 3px; margin-bottom: 15px; border-left: 3px solid #0e7490;">
                    <strong>ğŸ’¡ æç¤ºï¼š</strong>å®šä½åå°†è‡ªåŠ¨è·³è½¬åˆ°å¯¹åº”çš„é¡µé¢å¹¶é«˜äº®æ˜¾ç¤º
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="closeJumpModal()">å–æ¶ˆ</button>
                    <button onclick="confirmJump()" style="background-color: #0e7490;">å®šä½</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é¢œè‰²å›¾ä¾‹å¼¹çª— -->
    <div id="legendModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>ğŸ¨ æ—¥å¿—çº§åˆ«é¢œè‰²å›¾ä¾‹</h2>
                <span class="modal-close" onclick="closeLegendModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 15px; padding: 10px; background-color: var(--vscode-editorWidget-background); border-radius: 5px; border-left: 3px solid #f14c4c;">
                        <span style="font-size: 24px; color: #f14c4c; font-weight: bold;">â– </span>
                        <div>
                            <div style="font-weight: bold; font-size: 14px;">ERROR / FATAL / SEVERE</div>
                            <div style="font-size: 12px; color: var(--vscode-descriptionForeground); margin-top: 3px;">é”™è¯¯çº§åˆ«ï¼Œè¡¨ç¤ºç³»ç»Ÿå‡ºç°ä¸¥é‡é—®é¢˜</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px; padding: 10px; background-color: var(--vscode-editorWidget-background); border-radius: 5px; border-left: 3px solid #cca700;">
                        <span style="font-size: 24px; color: #cca700; font-weight: bold;">â– </span>
                        <div>
                            <div style="font-weight: bold; font-size: 14px;">WARN / WARNING</div>
                            <div style="font-size: 12px; color: var(--vscode-descriptionForeground); margin-top: 3px;">è­¦å‘Šçº§åˆ«ï¼Œè¡¨ç¤ºæ½œåœ¨é—®é¢˜æˆ–éœ€è¦å…³æ³¨çš„æƒ…å†µ</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px; padding: 10px; background-color: var(--vscode-editorWidget-background); border-radius: 5px; border-left: 3px solid #4fc1ff;">
                        <span style="font-size: 24px; color: #4fc1ff; font-weight: bold;">â– </span>
                        <div>
                            <div style="font-weight: bold; font-size: 14px;">INFO / INFORMATION</div>
                            <div style="font-size: 12px; color: var(--vscode-descriptionForeground); margin-top: 3px;">ä¿¡æ¯çº§åˆ«ï¼Œè®°å½•æ­£å¸¸çš„ä¸šåŠ¡æµç¨‹å’ŒçŠ¶æ€</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px; padding: 10px; background-color: var(--vscode-editorWidget-background); border-radius: 5px; border-left: 3px solid #b267e6;">
                        <span style="font-size: 24px; color: #b267e6; font-weight: bold;">â– </span>
                        <div>
                            <div style="font-weight: bold; font-size: 14px;">DEBUG / TRACE / VERBOSE</div>
                            <div style="font-size: 12px; color: var(--vscode-descriptionForeground); margin-top: 3px;">è°ƒè¯•çº§åˆ«ï¼Œç”¨äºè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px; padding: 10px; background-color: var(--vscode-editorWidget-background); border-radius: 5px; border-left: 3px solid var(--vscode-panel-border);">
                        <span style="font-size: 24px; color: var(--vscode-descriptionForeground); font-weight: bold;">â– </span>
                        <div>
                            <div style="font-weight: bold; font-size: 14px;">å…¶ä»–</div>
                            <div style="font-size: 12px; color: var(--vscode-descriptionForeground); margin-top: 3px;">æ— æ³•è¯†åˆ«çº§åˆ«çš„æ—¥å¿—è¡Œ</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 20px; padding: 10px; background-color: var(--vscode-editorWidget-background); border-radius: 5px; border-left: 3px solid #ffc107;">
                    <div style="font-weight: bold; margin-bottom: 5px;">ğŸ’¡ å¿«æ·é”®æç¤ºï¼š</div>
                    <div style="font-size: 12px; color: var(--vscode-descriptionForeground); line-height: 1.6;">
                        â€¢ å³é”®ç‚¹å‡»æ—¥å¿—è¡Œå¯å¤åˆ¶å†…å®¹/æ·»åŠ ä¹¦ç­¾<br>
                        â€¢ åŒå‡»æ—¥å¿—è¡Œå¯å¿«é€Ÿæ·»åŠ ä¹¦ç­¾<br>
                        â€¢ é€‰ä¸­æ–‡æœ¬åå³é”®å¯å¤åˆ¶é€‰ä¸­éƒ¨åˆ†<br>
                        â€¢ ä½¿ç”¨è¿‡æ»¤é¢æ¿å¿«é€Ÿç­›é€‰æ—¥å¿—çº§åˆ«
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ä¹¦ç­¾ç®¡ç†å¼¹çª— -->
    <div id="bookmarksModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>ğŸ“Œ ä¹¦ç­¾åˆ—è¡¨</h2>
                <span class="modal-close" onclick="closeBookmarksModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="bookmarksList" style="max-height: 400px; overflow-y: auto;">
                    <!-- ä¹¦ç­¾å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div style="margin-top: 15px; text-align: center; color: var(--vscode-descriptionForeground); font-size: 12px;">
                    ğŸ’¡ æç¤ºï¼šåŒå‡»æ—¥å¿—è¡Œå¯æ·»åŠ /ç§»é™¤ä¹¦ç­¾
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ³¨é‡Šç®¡ç†å¼¹çª— -->
    <div id="commentsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>ğŸ“ æ³¨é‡Šåˆ—è¡¨</h2>
                <span class="modal-close" onclick="closeCommentsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="commentsList" style="max-height: 400px; overflow-y: auto;">
                    <!-- æ³¨é‡Šå°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div style="margin-top: 15px; text-align: center; color: var(--vscode-descriptionForeground); font-size: 12px;">
                    ğŸ’¡ æç¤ºï¼šå³é”®ç‚¹å‡»æ—¥å¿—è¡Œå¯æ·»åŠ æ³¨é‡Š
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ /ç¼–è¾‘æ³¨é‡Šå¼¹çª— -->
    <div id="commentInputModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="commentInputTitle">ğŸ“ æ·»åŠ æ³¨é‡Š</h2>
                <span class="modal-close" onclick="closeCommentInputModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: bold; margin-bottom: 5px;">è¡Œå·ï¼š<span id="commentInputLineNumber"></span></div>
                    <div style="font-size: 12px; color: var(--vscode-descriptionForeground); font-family: 'Consolas', monospace; background-color: var(--vscode-editorWidget-background); padding: 8px; border-radius: 3px; margin-bottom: 10px; max-height: 60px; overflow-y: auto;" id="commentInputPreview"></div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ³¨é‡Šå†…å®¹ï¼š</label>
                    <textarea id="commentInputText" rows="4" style="width: 100%; padding: 8px; background-color: var(--vscode-input-background); color: var(--vscode-input-foreground); border: 1px solid var(--vscode-input-border); border-radius: 3px; font-family: inherit; resize: vertical;" placeholder="è¯·è¾“å…¥æ³¨é‡Šå†…å®¹..." onkeydown="if(event.ctrlKey && event.key === 'Enter') confirmCommentInput();"></textarea>
                    <div style="font-size: 11px; color: var(--vscode-descriptionForeground); margin-top: 5px;">ğŸ’¡ æç¤ºï¼šæŒ‰ Ctrl+Enter å¿«é€Ÿä¿å­˜</div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="closeCommentInputModal()">å–æ¶ˆ</button>
                    <button onclick="confirmCommentInput()" style="background-color: #10b981;">ç¡®å®š</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å»é‡ç»Ÿè®¡å¼¹çª— -->
    <div id="deduplicationModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 85vh;">
            <div class="modal-header">
                <h2>ğŸ” ç›¸ä¼¼æ—¥å¿—èšåˆåˆ†æ</h2>
                <span class="modal-close" onclick="closeDeduplicationModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                    <span style="font-weight: bold;">ç›¸ä¼¼åº¦é˜ˆå€¼ï¼š</span>
                    <input type="range" id="similarityThreshold" min="50" max="100" value="85" 
                           oninput="document.getElementById('thresholdValue').textContent = this.value + '%'" 
                           style="width: 200px;">
                    <span id="thresholdValue" style="min-width: 40px; font-weight: bold; color: #8b5cf6;">85%</span>
                    <button onclick="reanalyzeDeduplication()" style="background-color: #8b5cf6; padding: 5px 15px;">ğŸ”„ é‡æ–°åˆ†æ</button>
                </div>
                <div id="deduplicationResult" style="max-height: 60vh; overflow-y: auto;">
                    <div style="text-align: center; padding: 40px; color: var(--vscode-descriptionForeground);">
                        ğŸ” æ­£åœ¨åˆ†ææ—¥å¿—æ¨¡å¼...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é«˜çº§æœç´¢å¼¹çª— -->
    <div id="advancedSearchModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>ğŸ” é«˜çº§æœç´¢</h2>
                <span class="modal-close" onclick="closeAdvancedSearchModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">å…³é”®è¯ï¼š</label>
                    <input type="text" id="advSearchKeyword" placeholder="è¾“å…¥æœç´¢å…³é”®è¯" style="width: 100%; padding: 8px; background-color: var(--vscode-input-background); color: var(--vscode-input-foreground); border: 1px solid var(--vscode-input-border); border-radius: 3px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ—¶é—´èŒƒå›´ï¼š</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" id="advSearchStartTime" placeholder="å¼€å§‹æ—¶é—´ (2024-01-01 10:00:00)" style="padding: 8px; background-color: var(--vscode-input-background); color: var(--vscode-input-foreground); border: 1px solid var(--vscode-input-border); border-radius: 3px;">
                        <input type="text" id="advSearchEndTime" placeholder="ç»“æŸæ—¶é—´ (2024-01-01 18:00:00)" style="padding: 8px; background-color: var(--vscode-input-background); color: var(--vscode-input-foreground); border: 1px solid var(--vscode-input-border); border-radius: 3px;">
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ—¥å¿—çº§åˆ«ï¼š</label>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <label><input type="checkbox" id="advSearchError" checked> <span style="color: #f14c4c;">â– </span> ERROR</label>
                        <label><input type="checkbox" id="advSearchWarn" checked> <span style="color: #cca700;">â– </span> WARN</label>
                        <label><input type="checkbox" id="advSearchInfo" checked> <span style="color: #4fc1ff;">â– </span> INFO</label>
                        <label><input type="checkbox" id="advSearchDebug" checked> <span style="color: #b267e6;">â– </span> DEBUG</label>
                        <label><input type="checkbox" id="advSearchOther" checked> å…¶ä»–</label>
                    </div>
                </div>
                <div style="background-color: var(--vscode-editorWidget-background); padding: 10px; border-radius: 3px; margin-bottom: 15px; border-left: 3px solid #0e7490;">
                    <strong>ğŸ’¡ æç¤ºï¼š</strong>å¯ä»¥å•ç‹¬ä½¿ç”¨å…³é”®è¯ã€æ—¶é—´èŒƒå›´æˆ–çº§åˆ«ï¼Œä¹Ÿå¯ä»¥ç»„åˆä½¿ç”¨
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="closeAdvancedSearchModal()">å–æ¶ˆ</button>
                    <button onclick="confirmAdvancedSearch()" style="background-color: #0e7490;">æœç´¢</button>
                </div>
            </div>
        </div>
    </div>
    

    <script>
        const vscode = acquireVsCodeApi();
        let allLines = [];
        let currentSearchKeyword = '';
        let originalLines = []; // ä¿å­˜åŸå§‹æ•°æ®ç”¨äºè¿‡æ»¤
        let isFiltering = false; // æ ‡è®°æ˜¯å¦åœ¨è¿‡æ»¤æ¨¡å¼ä¸‹
        let bookmarks = new Set(); // ä¹¦ç­¾é›†åˆï¼Œå­˜å‚¨è¡Œå·
        let comments = new Map(); // æ³¨é‡Šé›†åˆï¼Œkeyä¸ºè¡Œå·ï¼Œvalueä¸ºæ³¨é‡Šå†…å®¹
        let timelineData = null; // æ—¶é—´çº¿æ•°æ®
        let isTimelineExpanded = true; // æ—¶é—´çº¿æ˜¯å¦å±•å¼€
        
        // åˆ†é¡µå‚æ•°
        let currentPage = 1;
        let pageSize = 100;
        let totalPages = 1;
        
        // æ•°æ®åŠ è½½çŠ¶æ€
        let totalLinesInFile = 0;
        let allDataLoaded = false;
        
        window.addEventListener('message', event => {
            const message = event.data;
            
            switch (message.command) {
                case 'fileLoaded':
                    handleFileLoaded(message.data);
                    break;
                case 'moreLines':
                    handleMoreLines(message.data);
                    break;
                case 'searchResults':
                    handleSearchResults(message.data);
                    break;
                case 'filterResults':
                    handleFilterResults(message.data);
                    break;
                case 'statisticsResults':
                    handleStatisticsResults(message.data);
                    break;
                case 'jumpToTimeResult':
                    handleJumpToTimeResult(message.data);
                    break;
                case 'jumpToLineInFullLogResult':
                    handleJumpToLineInFullLogResult(message.data);
                    break;
            }
        });
        
        function handleFileLoaded(data) {
            document.getElementById('fileName').textContent = data.fileName;
            document.getElementById('fileSize').textContent = data.fileSize;
            document.getElementById('totalLines').textContent = data.totalLines;
            
            totalLinesInFile = data.totalLines;
            allDataLoaded = data.allLoaded || false;
            isFiltering = false; // é‡ç½®è¿‡æ»¤çŠ¶æ€
            currentSearchKeyword = ''; // é‡ç½®æœç´¢å…³é”®è¯
            
            allLines = data.lines;
            originalLines = [...data.lines];
            currentPage = 1;
            updatePagination();
            renderLines();
            
            // ç”Ÿæˆæ—¶é—´çº¿
            generateTimeline();
            
            // å¦‚æœæ•°æ®æœªå…¨éƒ¨åŠ è½½ï¼Œæ˜¾ç¤ºæç¤º
            if (!allDataLoaded && allLines.length < totalLinesInFile) {
                showLoadMoreHint();
            }
        }
        
        function handleMoreLines(data) {
            allLines = allLines.concat(data.lines);
            originalLines = originalLines.concat(data.lines);
            
            // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½å…¨éƒ¨æ•°æ®
            if (allLines.length >= totalLinesInFile) {
                allDataLoaded = true;
            }
            
            updatePagination();
            renderLines();
        }
        
        function handleSearchResults(data) {
            currentSearchKeyword = data.keyword;
            allLines = data.results;
            currentPage = 1;
            updatePagination();
            renderLines();
        }
        
        function handleFilterResults(data) {
            console.log('ğŸ“¥ æ”¶åˆ°è¿‡æ»¤ç»“æœ:', data.results.length, 'æ¡');
            allLines = data.results;
            isFiltering = true; // è®¾ç½®ä¸ºè¿‡æ»¤æ¨¡å¼
            currentPage = 1;
            updatePagination();
            renderLines();
            
            // å¦‚æœè¿‡æ»¤ç»“æœä¸ºç©ºï¼Œç»™å‡ºå‹å¥½æç¤º
            if (data.results.length === 0) {
                const levelText = data.levels.join('ã€');
                vscode.postMessage({
                    command: 'showMessage',
                    type: 'warning',
                    message: `æœªæ‰¾åˆ° ${levelText} çº§åˆ«çš„æ—¥å¿—ï¼Œè¯·å°è¯•å…¶ä»–çº§åˆ«æˆ–æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯`
                });
            }
        }
        
        function handleStatisticsResults(data) {
            showStatsModal(data);
        }
        
        function handleJumpToLineInFullLogResult(data) {
            // é‡æ–°åŠ è½½å®Œæ•´æ—¥å¿—æ•°æ®
            document.getElementById('fileName').textContent = data.fileName;
            document.getElementById('fileSize').textContent = data.fileSize;
            document.getElementById('totalLines').textContent = data.totalLines;
            
            totalLinesInFile = data.totalLines;
            allDataLoaded = data.allLoaded || false;
            isFiltering = false; // é‡ç½®è¿‡æ»¤çŠ¶æ€
            currentSearchKeyword = ''; // é‡ç½®æœç´¢å…³é”®è¯
            
            allLines = data.lines;
            originalLines = [...data.lines];
            
            // è·³è½¬åˆ°ç›®æ ‡è¡Œ
            jumpToLine(data.targetLineNumber);
            
            // ç”Ÿæˆæ—¶é—´çº¿
            generateTimeline();
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showToast('âœ… å·²è·³è½¬åˆ°å®Œæ•´æ—¥å¿—');
        }
        
        function renderLines() {
            const container = document.getElementById('logContainer');
            container.innerHTML = '';
            
            console.log('ğŸ¨ æ¸²æŸ“æ—¥å¿— - å½“å‰ allLines æ•°é‡:', allLines.length);
            
            if (allLines.length === 0) {
                container.innerHTML = '<div class="loading">æ²¡æœ‰æ—¥å¿—æ•°æ®</div>';
                document.getElementById('pagination').style.display = 'none';
                document.getElementById('loadedLines').textContent = '0';
                console.log('âš ï¸ æ¸²æŸ“ç»“æœ: æ˜¾ç¤º"æ²¡æœ‰æ—¥å¿—æ•°æ®"');
                return;
            }
            
            // è®¡ç®—åˆ†é¡µ
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, allLines.length);
            const pageLines = allLines.slice(startIndex, endIndex);
            
            pageLines.forEach((line, index) => {
                const lineDiv = document.createElement('div');
                lineDiv.className = 'log-line';
                
                const actualLineNumber = line.lineNumber || startIndex + index + 1;
                
                // æ ¹æ®æ—¥å¿—çº§åˆ«æ·»åŠ æ ·å¼
                if (line.level) {
                    lineDiv.classList.add(line.level.toLowerCase());
                }
                
                // å¦‚æœæ˜¯ä¹¦ç­¾è¡Œï¼Œæ·»åŠ ä¹¦ç­¾æ ‡è®°
                if (bookmarks.has(actualLineNumber)) {
                    lineDiv.style.backgroundColor = 'rgba(255, 193, 7, 0.1)';
                    lineDiv.style.borderRight = '3px solid #ffc107';
                }
                
                const lineNumber = document.createElement('span');
                lineNumber.className = 'log-line-number';
                lineNumber.textContent = actualLineNumber.toString();
                
                // å¦‚æœæ˜¯ä¹¦ç­¾ï¼Œæ˜¾ç¤ºä¹¦ç­¾å›¾æ ‡
                if (bookmarks.has(actualLineNumber)) {
                    lineNumber.textContent = 'ğŸ“Œ ' + lineNumber.textContent;
                }
                
                const lineContent = document.createElement('span');
                lineContent.className = 'log-line-content';
                
                const content = line.content || line;
                
                // å°è¯•è§£æJSON/XMLå¹¶æ·»åŠ åˆ°æ—¥å¿—å†…å®¹åé¢
                const parsedStructure = detectAndParseStructuredData(content);
                
                // å¢å¼ºé«˜äº®åŠŸèƒ½
                let highlightedContent = highlightKeywords(content, currentSearchKeyword);
                
                // å¦‚æœæœ‰æ³¨é‡Šï¼Œæ·»åŠ æ³¨é‡Šå¾½ç« 
                if (comments.has(actualLineNumber)) {
                    highlightedContent += `<span class="comment-badge" onclick="event.stopPropagation(); editComment(${actualLineNumber})" title="ç‚¹å‡»ç¼–è¾‘æ³¨é‡Š">ğŸ“ æœ‰æ³¨é‡Š</span>`;
                }
                
                lineContent.innerHTML = highlightedContent;
                
                // æ·»åŠ å³é”®èœå•å¤åˆ¶åŠŸèƒ½
                lineDiv.oncontextmenu = (e) => {
                    e.preventDefault();
                    showContextMenu(e, content, actualLineNumber);
                };
                
                // æ·»åŠ åŒå‡»ä¹¦ç­¾åŠŸèƒ½
                lineDiv.ondblclick = (e) => {
                    e.stopPropagation();
                    toggleBookmark(actualLineNumber);
                };
                
                // æ·»åŠ ç‚¹å‡»è·³è½¬åŠŸèƒ½ï¼ˆä»…åœ¨æœç´¢æ¨¡å¼ä¸‹ï¼‰
                if (currentSearchKeyword || isFiltering) {
                    lineDiv.onclick = (e) => {
                        // å¦‚æœç‚¹å‡»çš„æ˜¯æ³¨é‡Šå¾½ç« ï¼Œä¸è·³è½¬
                        if (e.target.classList.contains('comment-badge')) {
                            return;
                        }
                        jumpToLineInFullLog(actualLineNumber);
                    };
                    lineDiv.style.cursor = 'pointer';
                    lineDiv.title = 'ç‚¹å‡»è·³è½¬åˆ°å®Œæ•´æ—¥å¿—ä¸­çš„æ­¤è¡Œ';
                }
                
                lineDiv.appendChild(lineNumber);
                lineDiv.appendChild(lineContent);
                
                // å¦‚æœè§£æå‡ºJSON/XMLç»“æ„ï¼Œæ·»åŠ åˆ°ä¸‹æ–¹
                if (parsedStructure) {
                    const structDiv = document.createElement('div');
                    structDiv.innerHTML = parsedStructure;
                    lineDiv.appendChild(structDiv);
                }
                
                // å¦‚æœæœ‰æ³¨é‡Šï¼Œåœ¨ä¸‹æ–¹æ˜¾ç¤ºæ³¨é‡Šå†…å®¹
                if (comments.has(actualLineNumber)) {
                    const commentDiv = document.createElement('div');
                    commentDiv.className = 'log-comment';
                    commentDiv.textContent = 'ğŸ“ ' + comments.get(actualLineNumber);
                    lineDiv.appendChild(commentDiv);
                }
                
                container.appendChild(lineDiv);
            });
            
            document.getElementById('loadedLines').textContent = allLines.length;
            document.getElementById('pagination').style.display = 'flex';
        }
        
        // å¢å¼ºçš„å…³é”®è¯é«˜äº®åŠŸèƒ½
        function highlightKeywords(content, keyword) {
            if (!content) return '';
            
            let result = escapeHtml(content);
            
            // é«˜äº®æ—¥å¿—çº§åˆ«
            result = result.replace(/\b(ERROR)\b/gi, '<span class="highlight-error">$1</span>');
            result = result.replace(/\b(WARN|WARNING)\b/gi, '<span class="highlight-warn">$1</span>');
            result = result.replace(/\b(INFO)\b/gi, '<span class="highlight-info">$1</span>');
            
            // é«˜äº®æ—¶é—´æˆ³
            result = result.replace(/(\d{4}[-/]\d{2}[-/]\d{2}[T\s]\d{2}:\d{2}:\d{2}(\.\d+)?)/g, '<span class="highlight-time">$1</span>');
            result = result.replace(/(\[\d{4}[-/]\d{2}[-/]\d{2}[T\s]\d{2}:\d{2}:\d{2}(\.\d+)?\])/g, '<span class="highlight-time">$1</span>');
            
            // é«˜äº®æœç´¢å…³é”®è¯
            if (keyword) {
                const regex = new RegExp('(' + escapeRegex(keyword) + ')', 'gi');
                result = result.replace(regex, '<span class="highlight">$1</span>');
            }
            
            return result;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        function search() {
            const keyword = document.getElementById('searchInput').value;
            const isRegex = document.getElementById('regexMode').checked;
            const isReverse = document.getElementById('reverseMode').checked;
            
            if (!keyword) {
                vscode.postMessage({
                    command: 'refresh'
                });
                currentSearchKeyword = '';
                return;
            }
            
            // ä¿å­˜æœç´¢å…³é”®è¯ç”¨äºé«˜äº®
            currentSearchKeyword = keyword;
            
            if (isRegex) {
                vscode.postMessage({
                    command: 'regexSearch',
                    pattern: keyword,
                    flags: 'gi',
                    reverse: isReverse
                });
            } else {
                vscode.postMessage({
                    command: 'search',
                    keyword: keyword,
                    reverse: isReverse
                });
            }
            
            if (isReverse) {
                showToast('ğŸ”½ åå‘æœç´¢ä¸­...');
            }
        }
        
        function applyFilter() {
            const levels = [];
            const errorChecked = document.getElementById('filterError').checked;
            const warnChecked = document.getElementById('filterWarn').checked;
            const infoChecked = document.getElementById('filterInfo').checked;
            const debugChecked = document.getElementById('filterDebug').checked;
            const otherChecked = document.getElementById('filterOther').checked;
            
            if (errorChecked) { levels.push('ERROR'); }
            if (warnChecked) { levels.push('WARN'); }
            if (infoChecked) { levels.push('INFO'); }
            if (debugChecked) { levels.push('DEBUG'); }
            
            console.log('Filter applied:', levels);
            console.log('Checkboxes:', { errorChecked, warnChecked, infoChecked, debugChecked, otherChecked });
            
            // æ›´æ–°å…¨é€‰æ¡†çŠ¶æ€
            const allChecked = errorChecked && warnChecked && infoChecked && debugChecked && otherChecked;
            const allUnchecked = !errorChecked && !warnChecked && !infoChecked && !debugChecked && !otherChecked;
            const filterAllCheckbox = document.getElementById('filterAll');
            
            console.log('ğŸ”µ æ£€æŸ¥å…¨é€‰çŠ¶æ€ - allChecked:', allChecked, 'allUnchecked:', allUnchecked);
            
            if (allChecked) {
                filterAllCheckbox.checked = true;
                filterAllCheckbox.indeterminate = false;
            } else if (allUnchecked) {
                filterAllCheckbox.checked = false;
                filterAllCheckbox.indeterminate = false;
            } else {
                filterAllCheckbox.indeterminate = true;
            }
            
            // å¦‚æœå…¨éƒ¨é€‰ä¸­ï¼Œåˆ·æ–°æ˜¾ç¤ºæ‰€æœ‰æ•°æ®
            if (allChecked) {
                console.log('âš ï¸ å…¨éƒ¨é€‰ä¸­ï¼Œåˆ·æ–°...');
                if (!currentSearchKeyword) {
                    vscode.postMessage({ command: 'refresh' });
                }
                return;
            }
            
            // å¦‚æœå…¨éƒ¨ä¸é€‰ï¼Œæ˜¾ç¤ºç©º
            if (levels.length === 0) {
                console.log('âš ï¸ æ²¡æœ‰é€‰æ‹©ä»»ä½•çº§åˆ«');
                allLines = [];
                renderLines();
                return;
            }
            
            // å‘é€ç­›é€‰è¯·æ±‚
            console.log('ğŸ“¤ å‘é€è¿‡æ»¤è¯·æ±‚:', levels);
            vscode.postMessage({
                command: 'filterByLevel',
                levels: levels
            });
        }
        
        function toggleAll() {
            const filterAll = document.getElementById('filterAll');
            const checked = filterAll.checked;
            
            document.getElementById('filterError').checked = checked;
            document.getElementById('filterWarn').checked = checked;
            document.getElementById('filterInfo').checked = checked;
            document.getElementById('filterDebug').checked = checked;
            document.getElementById('filterOther').checked = checked;
            
            filterAll.indeterminate = false;
            applyFilter();
        }
        
        function showStats() {
            vscode.postMessage({
                command: 'getStatistics'
            });
        }
        
        function showStatsModal(stats) {
            const grid = document.getElementById('statsGrid');
            
            // è½¬æ¢ Map ä¸ºæ•°ç»„å¹¶æ’åº
            const classStats = stats.classCounts ? 
                Array.from(Object.entries(stats.classCounts)).sort((a, b) => b[1] - a[1]).slice(0, 10) : [];
            const methodStats = stats.methodCounts ? 
                Array.from(Object.entries(stats.methodCounts)).sort((a, b) => b[1] - a[1]).slice(0, 10) : [];
            const threadStats = stats.threadCounts ? 
                Array.from(Object.entries(stats.threadCounts)).sort((a, b) => b[1] - a[1]).slice(0, 10) : [];
            
            grid.innerHTML = `
                <div class="stats-card">
                    <h3>æ€»è¡Œæ•°</h3>
                    <div class="value">${stats.totalLines}</div>
                </div>
                <div class="stats-card">
                    <h3>ERROR</h3>
                    <div class="value" style="color: #f14c4c;">${stats.errorCount}</div>
                </div>
                <div class="stats-card">
                    <h3>WARN</h3>
                    <div class="value" style="color: #cca700;">${stats.warnCount}</div>
                </div>
                <div class="stats-card">
                    <h3>INFO</h3>
                    <div class="value" style="color: #4fc1ff;">${stats.infoCount}</div>
                </div>
                <div class="stats-card">
                    <h3>DEBUG</h3>
                    <div class="value" style="color: #b267e6;">${stats.debugCount}</div>
                </div>
                <div class="stats-card">
                    <h3>å…¶ä»–</h3>
                    <div class="value">${stats.otherCount}</div>
                </div>
            `;
            
            if (stats.timeRange && stats.timeRange.start) {
                grid.innerHTML += `
                    <div class="stats-card" style="grid-column: 1 / -1;">
                        <h3>æ—¶é—´èŒƒå›´</h3>
                        <div style="font-size: 14px;">
                            ${new Date(stats.timeRange.start).toLocaleString()} - 
                            ${new Date(stats.timeRange.end).toLocaleString()}
                        </div>
                    </div>
                `;
            }
            
            // æ·»åŠ ç±»åç»Ÿè®¡
            if (classStats.length > 0) {
                grid.innerHTML += `
                    <div class="stats-card" style="grid-column: 1 / -1;">
                        <h3>ğŸ“Š æœ€æ´»è·ƒçš„ç±» (Top 10)</h3>
                        <div style="font-size: 13px; margin-top: 10px;">
                            ${classStats.map(([name, count]) => 
                                `<div style="padding: 5px 0; border-bottom: 1px solid var(--vscode-panel-border); cursor: pointer; transition: background-color 0.2s;" 
                                      onmouseover="this.style.backgroundColor='var(--vscode-list-hoverBackground)'" 
                                      onmouseout="this.style.backgroundColor='transparent'"
                                      onclick="filterByClassName('${name.replace(/'/g, "\\'")}')"
                                      title="ç‚¹å‡»ç­›é€‰åŒ…å«æ­¤ç±»çš„æ—¥å¿—">
                                    <span style="font-weight: bold; color: var(--vscode-textLink-foreground);">${name}</span>
                                    <span style="float: right; color: var(--vscode-descriptionForeground);">${count} æ¬¡</span>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }
            
            // æ·»åŠ æ–¹æ³•åç»Ÿè®¡
            if (methodStats.length > 0) {
                grid.innerHTML += `
                    <div class="stats-card" style="grid-column: 1 / -1;">
                        <h3>ğŸ”§ æœ€å¸¸è°ƒç”¨çš„æ–¹æ³• (Top 10)</h3>
                        <div style="font-size: 13px; margin-top: 10px;">
                            ${methodStats.map(([name, count]) => 
                                `<div style="padding: 5px 0; border-bottom: 1px solid var(--vscode-panel-border); cursor: pointer; transition: background-color 0.2s;" 
                                      onmouseover="this.style.backgroundColor='var(--vscode-list-hoverBackground)'" 
                                      onmouseout="this.style.backgroundColor='transparent'"
                                      onclick="filterByMethodName('${name.replace(/'/g, "\\'")}')"
                                      title="ç‚¹å‡»ç­›é€‰åŒ…å«æ­¤æ–¹æ³•çš„æ—¥å¿—">
                                    <span style="font-weight: bold; color: var(--vscode-textLink-foreground);">${name}</span>
                                    <span style="float: right; color: var(--vscode-descriptionForeground);">${count} æ¬¡</span>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }
            
            // æ·»åŠ çº¿ç¨‹åç»Ÿè®¡
            if (threadStats.length > 0) {
                grid.innerHTML += `
                    <div class="stats-card" style="grid-column: 1 / -1;">
                        <h3>ğŸ§µ æœ€æ´»è·ƒçš„çº¿ç¨‹ (Top 10)</h3>
                        <div style="font-size: 13px; margin-top: 10px;">
                            ${threadStats.map(([name, count]) => 
                                `<div style="padding: 5px 0; border-bottom: 1px solid var(--vscode-panel-border); cursor: pointer; transition: background-color 0.2s;" 
                                      onmouseover="this.style.backgroundColor='var(--vscode-list-hoverBackground)'" 
                                      onmouseout="this.style.backgroundColor='transparent'"
                                      onclick="filterByThreadName('${name.replace(/'/g, "\\'")}')"
                                      title="ç‚¹å‡»ç­›é€‰åŒ…å«æ­¤çº¿ç¨‹çš„æ—¥å¿—">
                                    <span style="font-weight: bold; color: var(--vscode-textLink-foreground);">${name}</span>
                                    <span style="float: right; color: var(--vscode-descriptionForeground);">${count} æ¬¡</span>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }
            
            // æ·»åŠ å»é‡ç»Ÿè®¡æŒ‰é’®
            grid.innerHTML += `
                <div class="stats-card" style="grid-column: 1 / -1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; cursor: pointer;" 
                     onclick="showDeduplicationStats()">
                    <h3 style="color: white; display: flex; align-items: center; gap: 10px;">
                        <span>ğŸ”</span>
                        <span>ç›¸ä¼¼æ—¥å¿—èšåˆåˆ†æ</span>
                    </h3>
                    <div style="font-size: 13px; opacity: 0.95; margin-top: 5px;">
                        ç‚¹å‡»æŸ¥çœ‹é‡å¤æ—¥å¿—æ¨¡å¼ç»Ÿè®¡ â†’
                    </div>
                </div>
            `;
            
            document.getElementById('statsModal').style.display = 'block';
        }
        
        function closeStatsModal() {
            document.getElementById('statsModal').style.display = 'none';
        }
        
        // ========== é¢œè‰²å›¾ä¾‹å¼¹çª— ==========
        function showLegendModal() {
            document.getElementById('legendModal').style.display = 'block';
        }
        
        function closeLegendModal() {
            document.getElementById('legendModal').style.display = 'none';
        }
        
        // ========== ä¹¦ç­¾åŠŸèƒ½ ==========
        function toggleBookmark(lineNumber) {
            if (bookmarks.has(lineNumber)) {
                bookmarks.delete(lineNumber);
                console.log('â– ç§»é™¤ä¹¦ç­¾:', lineNumber);
            } else {
                bookmarks.add(lineNumber);
                console.log('â• æ·»åŠ ä¹¦ç­¾:', lineNumber);
            }
            renderLines(); // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºä¹¦ç­¾æ ‡è®°
        }
        
        function showBookmarksModal() {
            const modal = document.getElementById('bookmarksModal');
            const list = document.getElementById('bookmarksList');
            
            if (bookmarks.size === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--vscode-descriptionForeground);">æš‚æ— ä¹¦ç­¾<br>åŒå‡»æ—¥å¿—è¡Œå¯æ·»åŠ ä¹¦ç­¾</div>';
            } else {
                const bookmarkArray = Array.from(bookmarks).sort((a, b) => a - b);
                list.innerHTML = bookmarkArray.map(lineNum => {
                    const line = allLines.find(l => l.lineNumber === lineNum);
                    const content = line ? (line.content || line) : 'ï¼ˆå·²ä¸å­˜åœ¨ï¼‰';
                    const preview = content.substring(0, 100) + (content.length > 100 ? '...' : '');
                    
                    return `
                        <div style="padding: 10px; margin-bottom: 10px; background-color: var(--vscode-editorWidget-background); border-radius: 5px; border-left: 3px solid #ffc107; cursor: pointer; transition: background-color 0.2s;"
                             onmouseover="this.style.backgroundColor='var(--vscode-list-hoverBackground)'"
                             onmouseout="this.style.backgroundColor='var(--vscode-editorWidget-background)'"
                             onclick="jumpToBookmark(${lineNum})">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <span style="font-weight: bold; color: var(--vscode-textLink-foreground);">ğŸ“Œ è¡Œ ${lineNum}</span>
                                <button onclick="event.stopPropagation(); removeBookmark(${lineNum})" style="padding: 2px 8px; font-size: 11px; background-color: #dc2626;">åˆ é™¤</button>
                            </div>
                            <div style="font-size: 12px; color: var(--vscode-descriptionForeground); font-family: 'Consolas', monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${escapeHtml(preview)}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            modal.style.display = 'block';
        }
        
        function closeBookmarksModal() {
            document.getElementById('bookmarksModal').style.display = 'none';
        }
        
        function jumpToBookmark(lineNumber) {
            closeBookmarksModal();
            jumpToLine(lineNumber);
        }
        
        function removeBookmark(lineNumber) {
            bookmarks.delete(lineNumber);
            showBookmarksModal(); // åˆ·æ–°ä¹¦ç­¾åˆ—è¡¨
            renderLines(); // é‡æ–°æ¸²æŸ“
        }
        
        // ==========  æ³¨é‡ŠåŠŸèƒ½ ==========
        let currentCommentLineNumber = null; // å½“å‰æ­£åœ¨ç¼–è¾‘æ³¨é‡Šçš„è¡Œå·
        
        function addOrEditComment(lineNumber) {
            console.log('ğŸ“ addOrEditComment è¢«è°ƒç”¨ï¼Œè¡Œå·:', lineNumber);
            
            currentCommentLineNumber = lineNumber;
            const existingComment = comments.get(lineNumber) || '';
            const line = allLines.find(l => l.lineNumber === lineNumber);
            const content = line ? (line.content || line) : '';
            const preview = content.substring(0, 100) + (content.length > 100 ? '...' : '');
            
            // è®¾ç½®å¼¹çª—å†…å®¹
            document.getElementById('commentInputTitle').textContent = existingComment ? 'âœï¸ ç¼–è¾‘æ³¨é‡Š' : 'ğŸ“ æ·»åŠ æ³¨é‡Š';
            document.getElementById('commentInputLineNumber').textContent = lineNumber;
            document.getElementById('commentInputPreview').textContent = content;
            document.getElementById('commentInputText').value = existingComment;
            
            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('commentInputModal').style.display = 'block';
            
            // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
            setTimeout(() => {
                const textarea = document.getElementById('commentInputText');
                textarea.focus();
                textarea.select();
            }, 100);
            
            console.log('âœ… æ³¨é‡Šè¾“å…¥å¼¹çª—å·²æ˜¾ç¤º');
        }
        
        function closeCommentInputModal() {
            document.getElementById('commentInputModal').style.display = 'none';
            currentCommentLineNumber = null;
        }
        
        function confirmCommentInput() {
            if (currentCommentLineNumber === null) {
                console.log('âš ï¸ æ²¡æœ‰å½“å‰ç¼–è¾‘çš„è¡Œå·');
                return;
            }
            
            const lineNumber = currentCommentLineNumber;
            const commentText = document.getElementById('commentInputText').value;
            const existingComment = comments.get(lineNumber) || '';
            
            console.log('ğŸ“ ç¡®è®¤æ³¨é‡Šè¾“å…¥ï¼Œè¡Œå·:', lineNumber, 'ï¼Œå†…å®¹:', commentText);
            
            if (commentText.trim()) {
                comments.set(lineNumber, commentText.trim());
                console.log('âœ… æ·»åŠ æ³¨é‡Š:', lineNumber, '-', commentText.trim());
                showToast(`âœ… æ³¨é‡Šå·²${existingComment ? 'æ›´æ–°' : 'æ·»åŠ '}`);
            } else if (existingComment) {
                // å¦‚æœè¾“å…¥ç©ºç™½ä¸”åŸæ¥æœ‰æ³¨é‡Šï¼Œåˆ™åˆ é™¤
                comments.delete(lineNumber);
                console.log('âŒ åˆ é™¤æ³¨é‡Š:', lineNumber);
                showToast('âŒ æ³¨é‡Šå·²åˆ é™¤');
            }
            
            renderLines();
            closeCommentInputModal();
        }
        
        function editComment(lineNumber) {
            addOrEditComment(lineNumber);
        }
        
        function deleteComment(lineNumber) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ³¨é‡Šå—ï¼Ÿ')) {
                comments.delete(lineNumber);
                console.log('âŒ åˆ é™¤æ³¨é‡Š:', lineNumber);
                showToast('âŒ æ³¨é‡Šå·²åˆ é™¤');
                renderLines();
            }
        }
        
        function showCommentsModal() {
            const modal = document.getElementById('commentsModal');
            const list = document.getElementById('commentsList');
            
            if (comments.size === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--vscode-descriptionForeground);">æš‚æ— æ³¨é‡Š<br>å³é”®ç‚¹å‡»æ—¥å¿—è¡Œå¯æ·»åŠ æ³¨é‡Š</div>';
            } else {
                // å°†Mapè½¬ä¸ºæ•°ç»„å¹¶æŒ‰è¡Œå·æ’åº
                const commentArray = Array.from(comments.entries()).sort((a, b) => a[0] - b[0]);
                list.innerHTML = commentArray.map(([lineNum, comment]) => {
                    const line = allLines.find(l => l.lineNumber === lineNum);
                    const content = line ? (line.content || line) : 'ï¼ˆå·²ä¸å­˜åœ¨ï¼‰';
                    const preview = content.substring(0, 80) + (content.length > 80 ? '...' : '');
                    
                    return `
                        <div style="padding: 12px; margin-bottom: 10px; background-color: var(--vscode-editorWidget-background); border-radius: 5px; border-left: 3px solid #10b981;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: bold; color: var(--vscode-textLink-foreground); cursor: pointer;" onclick="jumpToComment(${lineNum})">ğŸ“ è¡Œ ${lineNum}</span>
                                <div style="display: flex; gap: 5px;">
                                    <button onclick="editComment(${lineNum})" style="padding: 2px 8px; font-size: 11px; background-color: #0e7490;">ç¼–è¾‘</button>
                                    <button onclick="deleteCommentFromList(${lineNum})" style="padding: 2px 8px; font-size: 11px; background-color: #dc2626;">åˆ é™¤</button>
                                </div>
                            </div>
                            <div style="font-size: 11px; color: var(--vscode-descriptionForeground); font-family: 'Consolas', monospace; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${escapeHtml(preview)}
                            </div>
                            <div style="background-color: rgba(16, 185, 129, 0.1); padding: 8px; border-radius: 3px; font-size: 12px; font-style: italic; color: var(--vscode-editor-foreground);">
                                ${escapeHtml(comment)}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            modal.style.display = 'block';
        }
        
        function closeCommentsModal() {
            document.getElementById('commentsModal').style.display = 'none';
        }
        
        function jumpToComment(lineNumber) {
            closeCommentsModal();
            jumpToLine(lineNumber);
        }
        
        function deleteCommentFromList(lineNumber) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ³¨é‡Šå—ï¼Ÿ')) {
                comments.delete(lineNumber);
                showCommentsModal(); // åˆ·æ–°æ³¨é‡Šåˆ—è¡¨
                renderLines(); // é‡æ–°æ¸²æŸ“
                showToast('âŒ æ³¨é‡Šå·²åˆ é™¤');
            }
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: #10b981;
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                font-weight: bold;
                z-index: 10000;
                animation: fadeInOut 2s ease-in-out;
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 2000);
        }
        
        // ========== å¤åˆ¶åŠŸèƒ½ ==========
        let currentContextMenu = null;
        
        function showContextMenu(event, content, lineNumber) {
            console.log('ğŸ–±ï¸ showContextMenu è¢«è°ƒç”¨ï¼Œè¡Œå·:', lineNumber);
            
            // ç§»é™¤æ—§çš„èœå•
            if (currentContextMenu) {
                document.body.removeChild(currentContextMenu);
            }
            
            // è·å–é€‰ä¸­çš„æ–‡æœ¬
            const selectedText = window.getSelection().toString();
            
            // åˆ›å»ºèœå•
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            
            // å¤åˆ¶é€‰ä¸­æ–‡æœ¬
            if (selectedText) {
                const copySelectedItem = document.createElement('div');
                copySelectedItem.className = 'context-menu-item';
                copySelectedItem.innerHTML = '<span>ğŸ“‹</span><span>å¤åˆ¶é€‰ä¸­å†…å®¹</span>';
                copySelectedItem.onclick = (e) => {
                    e.stopPropagation();
                    copyToClipboard(selectedText);
                    closeContextMenu();
                };
                menu.appendChild(copySelectedItem);
                
                // åˆ†éš”çº¿
                const separator1 = document.createElement('div');
                separator1.className = 'context-menu-separator';
                menu.appendChild(separator1);
            }
            
            // å¤åˆ¶æ•´è¡Œ
            const copyLineItem = document.createElement('div');
            copyLineItem.className = 'context-menu-item';
            copyLineItem.innerHTML = '<span>ğŸ“„</span><span>å¤åˆ¶æ•´è¡Œ</span>';
            copyLineItem.onclick = (e) => {
                e.stopPropagation();
                copyToClipboard(content);
                closeContextMenu();
            };
            menu.appendChild(copyLineItem);
            
            // åˆ†éš”çº¿
            const separator2 = document.createElement('div');
            separator2.className = 'context-menu-separator';
            menu.appendChild(separator2);
            
            // æ·»åŠ /ç§»é™¤ä¹¦ç­¾
            const bookmarkItem = document.createElement('div');
            bookmarkItem.className = 'context-menu-item';
            const isBookmarked = bookmarks.has(lineNumber);
            bookmarkItem.innerHTML = isBookmarked 
                ? '<span>âŒ</span><span>ç§»é™¤ä¹¦ç­¾</span>' 
                : '<span>ğŸ“Œ</span><span>æ·»åŠ ä¹¦ç­¾</span>';
            bookmarkItem.onclick = (e) => {
                e.stopPropagation();
                toggleBookmark(lineNumber);
                closeContextMenu();
            };
            menu.appendChild(bookmarkItem);
            
            // æ·»åŠ /ç¼–è¾‘æ³¨é‡Š
            const commentItem = document.createElement('div');
            commentItem.className = 'context-menu-item';
            const hasComment = comments.has(lineNumber);
            commentItem.innerHTML = hasComment
                ? '<span>âœï¸</span><span>ç¼–è¾‘æ³¨é‡Š</span>'
                : '<span>ğŸ“</span><span>æ·»åŠ æ³¨é‡Š</span>';
            commentItem.onclick = (e) => {
                console.log('ğŸ–±ï¸ ç‚¹å‡»äº†æ·»åŠ æ³¨é‡Šèœå•é¡¹ï¼Œè¡Œå·:', lineNumber);
                e.stopPropagation();
                e.preventDefault();
                closeContextMenu();
                // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿èœå•å…ˆå…³é—­
                setTimeout(() => {
                    console.log('â° å‡†å¤‡è°ƒç”¨ addOrEditCommentï¼Œè¡Œå·:', lineNumber);
                    addOrEditComment(lineNumber);
                }, 100);
            };
            menu.appendChild(commentItem);
            
            // å¦‚æœå·²æœ‰æ³¨é‡Šï¼Œæ˜¾ç¤ºåˆ é™¤æ³¨é‡Šé€‰é¡¹
            if (hasComment) {
                const deleteCommentItem = document.createElement('div');
                deleteCommentItem.className = 'context-menu-item';
                deleteCommentItem.innerHTML = '<span>ğŸ—‘ï¸</span><span>åˆ é™¤æ³¨é‡Š</span>';
                deleteCommentItem.onclick = (e) => {
                    e.stopPropagation();
                    deleteComment(lineNumber);
                    closeContextMenu();
                };
                menu.appendChild(deleteCommentItem);
            }
            
            // åˆ†éš”çº¿
            const separator3 = document.createElement('div');
            separator3.className = 'context-menu-separator';
            menu.appendChild(separator3);
            
            // å®šä½åˆ°æ­¤è¡Œ
            const jumpItem = document.createElement('div');
            jumpItem.className = 'context-menu-item';
            jumpItem.innerHTML = '<span>ğŸ¯</span><span>å®šä½åˆ°ç¬¬ ' + lineNumber + ' è¡Œ</span>';
            jumpItem.onclick = (e) => {
                e.stopPropagation();
                jumpToLine(lineNumber);
                closeContextMenu();
            };
            menu.appendChild(jumpItem);
            
            // è®¾ç½®ä½ç½®
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            
            document.body.appendChild(menu);
            currentContextMenu = menu;
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
            setTimeout(() => {
                document.addEventListener('click', closeContextMenu);
            }, 0);
        }
        
        function closeContextMenu() {
            if (currentContextMenu) {
                document.body.removeChild(currentContextMenu);
                currentContextMenu = null;
            }
            document.removeEventListener('click', closeContextMenu);
        }
        
        function copyToClipboard(text) {
            // ä½¿ç”¨ Clipboard API
            navigator.clipboard.writeText(text).then(() => {
                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
                showCopyToast();
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
            });
        }
        
        function showCopyToast() {
            const toast = document.createElement('div');
            toast.textContent = 'âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: #10b981;
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                font-weight: bold;
                z-index: 10000;
                animation: fadeInOut 2s ease-in-out;
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 2000);
        }
        
        // ========== é«˜çº§æœç´¢ ==========
        function showAdvancedSearchModal() {
            document.getElementById('advancedSearchModal').style.display = 'block';
        }
        
        function closeAdvancedSearchModal() {
            document.getElementById('advancedSearchModal').style.display = 'none';
        }
        
        function confirmAdvancedSearch() {
            const keyword = document.getElementById('advSearchKeyword').value.trim();
            const startTime = document.getElementById('advSearchStartTime').value.trim();
            const endTime = document.getElementById('advSearchEndTime').value.trim();
            
            const levels = [];
            if (document.getElementById('advSearchError').checked) levels.push('ERROR');
            if (document.getElementById('advSearchWarn').checked) levels.push('WARN');
            if (document.getElementById('advSearchInfo').checked) levels.push('INFO');
            if (document.getElementById('advSearchDebug').checked) levels.push('DEBUG');
            if (document.getElementById('advSearchOther').checked) levels.push('OTHER');
            
            console.log('ğŸ” é«˜çº§æœç´¢:', { keyword, startTime, endTime, levels });
            
            // åœ¨å·²åŠ è½½çš„æ•°æ®ä¸­è¿›è¡Œè¿‡æ»¤
            let results = [...allLines];
            
            // è¿‡æ»¤å…³é”®è¯
            if (keyword) {
                results = results.filter(line => {
                    const content = line.content || line;
                    return content.includes(keyword);
                });
            }
            
            // è¿‡æ»¤æ—¶é—´èŒƒå›´
            if (startTime || endTime) {
                results = results.filter(line => {
                    if (!line.timestamp) return false;
                    const lineTime = new Date(line.timestamp);
                    
                    if (startTime) {
                        const start = new Date(startTime);
                        if (lineTime < start) return false;
                    }
                    
                    if (endTime) {
                        const end = new Date(endTime);
                        if (lineTime > end) return false;
                    }
                    
                    return true;
                });
            }
            
            // è¿‡æ»¤çº§åˆ«
            if (levels.length > 0 && levels.length < 5) {
                results = results.filter(line => {
                    const level = line.level ? line.level.toUpperCase() : 'OTHER';
                    return levels.includes(level);
                });
            }
            
            console.log('âœ… æœç´¢ç»“æœ:', results.length, 'æ¡');
            
            allLines = results;
            currentPage = 1;
            isFiltering = true;
            updatePagination();
            renderLines();
            
            closeAdvancedSearchModal();
            
            if (results.length === 0) {
                alert('æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ—¥å¿—ï¼');
            }
        }
        
        
        // ========== æ—¶é—´çº¿åŠŸèƒ½ ==========
        function toggleTimeline() {
            isTimelineExpanded = !isTimelineExpanded;
            const content = document.getElementById('timelineContent');
            const icon = document.getElementById('timelineToggleIcon');
            
            if (isTimelineExpanded) {
                content.style.display = 'block';
                icon.textContent = 'â–¼';
            } else {
                content.style.display = 'none';
                icon.textContent = 'â–¶';
            }
        }
        
        function generateTimeline() {
            // æå–æ‰€æœ‰å¸¦æ—¶é—´æˆ³çš„æ—¥å¿—
            const logsWithTime = allLines.filter(line => line.timestamp);
            
            if (logsWithTime.length === 0) {
                document.getElementById('timelinePanel').style.display = 'none';
                return;
            }
            
            // æ˜¾ç¤ºæ—¶é—´çº¿é¢æ¿
            document.getElementById('timelinePanel').style.display = 'block';
            
            // è·å–æ—¶é—´èŒƒå›´
            const timestamps = logsWithTime.map(line => new Date(line.timestamp).getTime());
            const minTime = Math.min(...timestamps);
            const maxTime = Math.max(...timestamps);
            const timeRange = maxTime - minTime;
            
            // åˆ†æˆ20ä¸ªæ—¶é—´æ®µ
            const bucketCount = 20;
            const bucketSize = timeRange / bucketCount;
            const buckets = new Array(bucketCount).fill(0).map(() => ({
                count: 0,
                error: 0,
                warn: 0,
                info: 0,
                debug: 0,
                lines: []
            }));
            
            // ç»Ÿè®¡æ¯ä¸ªæ—¶é—´æ®µçš„æ—¥å¿—æ•°é‡
            logsWithTime.forEach(line => {
                const time = new Date(line.timestamp).getTime();
                const bucketIndex = Math.min(Math.floor((time - minTime) / bucketSize), bucketCount - 1);
                
                buckets[bucketIndex].count++;
                buckets[bucketIndex].lines.push(line);
                
                const level = (line.level || 'OTHER').toUpperCase();
                if (level === 'ERROR') buckets[bucketIndex].error++;
                else if (level === 'WARN') buckets[bucketIndex].warn++;
                else if (level === 'INFO') buckets[bucketIndex].info++;
                else if (level === 'DEBUG') buckets[bucketIndex].debug++;
            });
            
            timelineData = {
                buckets,
                minTime,
                maxTime,
                bucketSize
            };
            
            // ç»˜åˆ¶æ—¶é—´çº¿
            drawTimeline();
            
            // æ˜¾ç¤ºæ—¶é—´èŒƒå›´
            const startDate = new Date(minTime);
            const endDate = new Date(maxTime);
            const info = document.getElementById('timelineInfo');
            info.innerHTML = `<span>æ—¶é—´èŒƒå›´: ${formatDate(startDate)} è‡³ ${formatDate(endDate)}</span> <span style="margin-left: 20px;">æ€»è®¡: ${logsWithTime.length} æ¡æ—¥å¿—</span>`;
        }
        
        function drawTimeline() {
            if (!timelineData) return;
            
            const canvas = document.getElementById('timelineCanvas');
            const ctx = canvas.getContext('2d');
            
            // è®¾ç½®ç”»å¸ƒå¤§å°
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = 80;
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const { buckets } = timelineData;
            const maxCount = Math.max(...buckets.map(b => b.count));
            
            const barWidth = canvas.width / buckets.length;
            const maxHeight = canvas.height - 20;
            
            // ç»˜åˆ¶æŸ±çŠ¶å›¾
            buckets.forEach((bucket, i) => {
                const x = i * barWidth;
                const heightRatio = bucket.count / maxCount;
                
                // ç»˜åˆ¶åˆ†å±‚æŸ±çŠ¶å›¾ï¼ˆæŒ‰çº§åˆ«ï¼‰
                let currentY = canvas.height - 20;
                
                // ERROR (çº¢è‰²)
                if (bucket.error > 0) {
                    const h = (bucket.error / bucket.count) * heightRatio * maxHeight;
                    ctx.fillStyle = '#f14c4c';
                    ctx.fillRect(x + 1, currentY - h, barWidth - 2, h);
                    currentY -= h;
                }
                
                // WARN (æ©™è‰²)
                if (bucket.warn > 0) {
                    const h = (bucket.warn / bucket.count) * heightRatio * maxHeight;
                    ctx.fillStyle = '#cca700';
                    ctx.fillRect(x + 1, currentY - h, barWidth - 2, h);
                    currentY -= h;
                }
                
                // INFO (è“è‰²)
                if (bucket.info > 0) {
                    const h = (bucket.info / bucket.count) * heightRatio * maxHeight;
                    ctx.fillStyle = '#4fc1ff';
                    ctx.fillRect(x + 1, currentY - h, barWidth - 2, h);
                    currentY -= h;
                }
                
                // DEBUG (ç´«è‰²)
                if (bucket.debug > 0) {
                    const h = (bucket.debug / bucket.count) * heightRatio * maxHeight;
                    ctx.fillStyle = '#b267e6';
                    ctx.fillRect(x + 1, currentY - h, barWidth - 2, h);
                }
            });
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            canvas.onclick = (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const bucketIndex = Math.floor(x / barWidth);
                
                if (bucketIndex >= 0 && bucketIndex < buckets.length) {
                    const bucket = buckets[bucketIndex];
                    if (bucket.lines.length > 0) {
                        // è·³è½¬åˆ°è¯¥æ—¶é—´æ®µçš„ç¬¬ä¸€æ¡æ—¥å¿—
                        const targetLine = bucket.lines[0];
                        jumpToLine(targetLine.lineNumber);
                    }
                }
            };
            
            // æ·»åŠ é¼ æ ‡æ‚¬åœæç¤º
            canvas.onmousemove = (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const bucketIndex = Math.floor(x / barWidth);
                
                if (bucketIndex >= 0 && bucketIndex < buckets.length) {
                    const bucket = buckets[bucketIndex];
                    const startTime = new Date(timelineData.minTime + bucketIndex * timelineData.bucketSize);
                    canvas.title = `${formatTime(startTime)}\næ€»è®¡: ${bucket.count} æ¡\nERROR: ${bucket.error} | WARN: ${bucket.warn} | INFO: ${bucket.info} | DEBUG: ${bucket.debug}`;
                }
            };
        }
        
        function formatDate(date) {
            return date.toLocaleString('zh-CN', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }
        
        function formatTime(date) {
            return date.toLocaleString('zh-CN', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        // æŒ‰ç±»åç­›é€‰
        function filterByClassName(className) {
            console.log('ğŸ” æŒ‰ç±»åç­›é€‰:', className);
            closeStatsModal();
            // ä½¿ç”¨æ­£åˆ™æœç´¢
            vscode.postMessage({
                command: 'regexSearch',
                pattern: className.replace(/\./g, '\\.'),  // è½¬ä¹‰ç‚¹å·
                flags: 'i'
            });
        }
        
        // æŒ‰æ–¹æ³•åç­›é€‰
        function filterByMethodName(methodName) {
            console.log('ğŸ”§ æŒ‰æ–¹æ³•åç­›é€‰:', methodName);
            closeStatsModal();
            // æœç´¢ <æ–¹æ³•å> æˆ– æ–¹æ³•åæ¥å£
            vscode.postMessage({
                command: 'regexSearch',
                pattern: `(<${methodName}>|${methodName}æ¥å£)`,
                flags: 'i'
            });
        }
        
        // æŒ‰çº¿ç¨‹åç­›é€‰
        function filterByThreadName(threadName) {
            console.log('ğŸ§µ æŒ‰çº¿ç¨‹åç­›é€‰:', threadName);
            closeStatsModal();
            // æœç´¢ [çº¿ç¨‹å]
            vscode.postMessage({
                command: 'regexSearch',
                pattern: `\\[${threadName}\\]`,
                flags: 'i'
            });
        }
        
        function showDeleteByTimeDialog() {
            document.getElementById('deleteByTimeModal').style.display = 'block';
        }
        
        function closeDeleteByTimeModal() {
            document.getElementById('deleteByTimeModal').style.display = 'none';
            document.getElementById('deleteTimeInput').value = '';
        }
        
        // ========== åˆ é™¤æ–¹å¼é€‰æ‹© ==========
        function showDeleteModal() {
            document.getElementById('deleteModal').style.display = 'block';
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
        }
        
        function selectDeleteByTime() {
            closeDeleteModal();
            showDeleteByTimeDialog();
        }
        
        function selectDeleteByLine() {
            closeDeleteModal();
            showDeleteByLineDialog();
        }
        
        function confirmDeleteByTime() {
            const timeStr = document.getElementById('deleteTimeInput').value.trim();
            const mode = document.getElementById('deleteTimeMode').value;
            
            if (!timeStr) {
                alert('è¯·è¾“å…¥æ—¶é—´ï¼');
                return;
            }
            
            // ç®€å•éªŒè¯æ—¶é—´æ ¼å¼
            if (!/^\d{4}-\d{2}-\d{2}/.test(timeStr)) {
                alert('æ—¶é—´æ ¼å¼ä¸æ­£ç¡®ï¼è¯·ä½¿ç”¨æ ¼å¼ï¼š2024-01-01 12:00:00 æˆ– 2024-01-01');
                return;
            }
            
            vscode.postMessage({
                command: 'deleteByTime',
                timeStr: timeStr,
                mode: mode
            });
            
            closeDeleteByTimeModal();
        }
        
        function showDeleteByLineDialog() {
            document.getElementById('deleteByLineModal').style.display = 'block';
        }
        
        function closeDeleteByLineModal() {
            document.getElementById('deleteByLineModal').style.display = 'none';
            document.getElementById('deleteLineInput').value = '';
        }
        
        function showJumpDialog() {
            document.getElementById('jumpModal').style.display = 'block';
            document.getElementById('jumpLineInput').focus();
        }
        
        function closeJumpModal() {
            document.getElementById('jumpModal').style.display = 'none';
            document.getElementById('jumpLineInput').value = '';
            document.getElementById('jumpTimeInput').value = '';
        }
        
        function switchJumpMode() {
            const mode = document.getElementById('jumpMode').value;
            const lineSection = document.getElementById('jumpByLineSection');
            const timeSection = document.getElementById('jumpByTimeSection');
            
            if (mode === 'line') {
                lineSection.style.display = 'block';
                timeSection.style.display = 'none';
                document.getElementById('jumpLineInput').focus();
            } else {
                lineSection.style.display = 'none';
                timeSection.style.display = 'block';
                document.getElementById('jumpTimeInput').focus();
            }
        }
        
        function confirmJump() {
            const mode = document.getElementById('jumpMode').value;
            
            if (mode === 'line') {
                const lineNumber = parseInt(document.getElementById('jumpLineInput').value);
                if (!lineNumber || lineNumber < 1) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è¡Œå·ï¼ˆå¤§äº0çš„æ•´æ•°ï¼‰ï¼');
                    return;
                }
                if (lineNumber > allLines.length) {
                    alert(`è¡Œå·è¶…å‡ºèŒƒå›´ï¼å½“å‰æ€»è¡Œæ•°ï¼š${allLines.length}`);
                    return;
                }
                jumpToLine(lineNumber);
            } else {
                const timeStr = document.getElementById('jumpTimeInput').value.trim();
                if (!timeStr) {
                    alert('è¯·è¾“å…¥æ—¶é—´ï¼');
                    return;
                }
                if (!/^\d{4}-\d{2}-\d{2}/.test(timeStr)) {
                    alert('æ—¶é—´æ ¼å¼ä¸æ­£ç¡®ï¼è¯·ä½¿ç”¨æ ¼å¼ï¼š2024-01-01 12:00:00 æˆ– 2024-01-01');
                    return;
                }
                jumpToTime(timeStr);
            }
            
            closeJumpModal();
        }
        
        function jumpToLine(lineNumber) {
            console.log('ğŸ¯ å®šä½åˆ°è¡Œå·:', lineNumber);
            
            // è®¡ç®—ç›®æ ‡è¡Œæ‰€åœ¨çš„é¡µé¢
            const targetPage = Math.ceil(lineNumber / pageSize);
            currentPage = targetPage;
            updatePagination();
            renderLines();
            
            // ç­‰å¾…æ¸²æŸ“å®Œæˆåé«˜äº®ç›®æ ‡è¡Œ
            setTimeout(() => {
                highlightTargetLine(lineNumber);
            }, 100);
        }
        
        // ä»æœç´¢ç»“æœè·³è½¬åˆ°å®Œæ•´æ—¥å¿—çš„æŒ‡å®šè¡Œ
        function jumpToLineInFullLog(lineNumber) {
            console.log('ğŸš€ è·³è½¬åˆ°å®Œæ•´æ—¥å¿—çš„è¡Œ:', lineNumber);
            
            // æ¸…é™¤æœç´¢å…³é”®è¯å’Œè¿‡æ»¤çŠ¶æ€
            currentSearchKeyword = '';
            document.getElementById('searchInput').value = '';
            isFiltering = false;
            
            // æ˜¾ç¤ºåŠ è½½æç¤º
            showToast('ğŸ“¦ æ­£åœ¨åŠ è½½å®Œæ•´æ—¥å¿—...');
            
            // è¯·æ±‚åç«¯é‡æ–°åŠ è½½å®Œæ•´æ—¥å¿—ï¼Œå¹¶è·³è½¬åˆ°æŒ‡å®šè¡Œ
            vscode.postMessage({
                command: 'jumpToLineInFullLog',
                lineNumber: lineNumber
            });
        }
        
        function jumpToTime(timeStr) {
            console.log('ğŸ¯ å®šä½åˆ°æ—¶é—´:', timeStr);
            
            // ç›´æ¥è¯·æ±‚åç«¯æŸ¥æ‰¾
            vscode.postMessage({
                command: 'jumpToTime',
                timeStr: timeStr
            });
        }
        
        function handleJumpToTimeResult(data) {
            if (data.success) {
                console.log('âœ… æ‰¾åˆ°ç›®æ ‡æ—¶é—´çš„æ—¥å¿—ï¼Œè¡Œå·:', data.targetLineNumber);
                
                // åˆå¹¶æ–°åŠ è½½çš„æ•°æ®
                const newLines = data.lines;
                const startLine = data.startLine;
                
                // æ›´æ–° allLinesï¼šå¦‚æœæ–°æ•°æ®è¦†ç›–äº†å·²åŠ è½½çš„èŒƒå›´ï¼Œåˆ™åˆå¹¶
                if (allLines.length === 0 || startLine >= allLines.length) {
                    // æ–°æ•°æ®åœ¨å·²åŠ è½½æ•°æ®ä¹‹åï¼Œç›´æ¥è¿½åŠ 
                    allLines = allLines.concat(newLines);
                } else {
                    // æ›¿æ¢æˆ–æ’å…¥æ–°æ•°æ®
                    for (let i = 0; i < newLines.length; i++) {
                        const globalIndex = startLine + i;
                        if (globalIndex < allLines.length) {
                            allLines[globalIndex] = newLines[i];
                        } else {
                            allLines.push(newLines[i]);
                        }
                    }
                }
                
                // è·³è½¬åˆ°ç›®æ ‡è¡Œ
                jumpToLine(data.targetLineNumber);
            } else {
                console.error('âŒ æœªæ‰¾åˆ°ç›®æ ‡æ—¶é—´çš„æ—¥å¿—');
                alert(data.message || 'æœªæ‰¾åˆ°å¤§äºæˆ–ç­‰äºè¯¥æ—¶é—´çš„æ—¥å¿—ï¼');
            }
        }
        
        function highlightTargetLine(lineNumber) {
            // ç§»é™¤ä¹‹å‰çš„é«˜äº®
            document.querySelectorAll('.log-line.highlight-target').forEach(el => {
                el.classList.remove('highlight-target');
            });
            
            // æŸ¥æ‰¾ç›®æ ‡è¡Œ
            const logLines = document.querySelectorAll('.log-line');
            const startIndex = (currentPage - 1) * pageSize;
            const indexInPage = lineNumber - startIndex - 1;
            
            if (indexInPage >= 0 && indexInPage < logLines.length) {
                const targetLine = logLines[indexInPage];
                targetLine.classList.add('highlight-target');
                // æ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
                targetLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // 3ç§’åç§»é™¤é«˜äº®
                setTimeout(() => {
                    targetLine.classList.remove('highlight-target');
                }, 3000);
            }
        }
        
        function confirmDeleteByLine() {
            const lineNumber = parseInt(document.getElementById('deleteLineInput').value);
            const mode = document.getElementById('deleteLineMode').value;
            
            if (!lineNumber || lineNumber < 1) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è¡Œå·ï¼ˆå¤§äº0çš„æ•´æ•°ï¼‰ï¼');
                return;
            }
            
            vscode.postMessage({
                command: 'deleteByLine',
                lineNumber: lineNumber,
                mode: mode
            });
            
            closeDeleteByLineModal();
        }
        
        function exportLogs() {
            vscode.postMessage({
                command: 'exportLogs',
                lines: allLines
            });
        }
        
        function refresh() {
            currentSearchKeyword = '';
            document.getElementById('searchInput').value = '';
            currentPage = 1;
            isFiltering = false; // é€€å‡ºè¿‡æ»¤æ¨¡å¼
            vscode.postMessage({
                command: 'refresh'
            });
        }
        
        // åˆ†é¡µåŠŸèƒ½
        function updatePagination() {
            totalPages = Math.ceil(allLines.length / pageSize);
            if (totalPages < 1) totalPages = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            
            document.getElementById('currentPageInput').value = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('totalLinesInPage').textContent = allLines.length;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('firstPageBtn').disabled = currentPage === 1;
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
            document.getElementById('lastPageBtn').disabled = currentPage === totalPages;
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦åŠ è½½æ›´å¤šæ•°æ®
            checkAndLoadMore();
        }
        
        function checkAndLoadMore() {
            // å¦‚æœå·²åŠ è½½å…¨éƒ¨æ•°æ®ï¼Œä¸å†åŠ è½½
            if (allDataLoaded) return;
            
            // å¦‚æœå¤„äºè¿‡æ»¤æ¨¡å¼ï¼Œä¸è‡ªåŠ¨åŠ è½½æ›´å¤šæ•°æ®
            if (isFiltering) {
                console.log('ğŸš« å¤„äºè¿‡æ»¤æ¨¡å¼ï¼Œä¸åŠ è½½æ›´å¤šæ•°æ®');
                return;
            }
            
            // å¦‚æœå½“å‰é¡µæ¥è¿‘å·²åŠ è½½æ•°æ®çš„æœ«å°¾ï¼Œè‡ªåŠ¨åŠ è½½æ›´å¤š
            const loadedLines = allLines.length;
            const currentMaxLine = currentPage * pageSize;
            
            if (currentMaxLine >= loadedLines - 500 && loadedLines < totalLinesInFile) {
                loadMoreData();
            }
        }
        
        function loadMoreData() {
            if (allDataLoaded) return;
            
            const currentLoaded = allLines.length;
            const remaining = totalLinesInFile - currentLoaded;
            const toLoad = Math.min(remaining, 10000); // æ¯æ¬¡åŠ è½½10000è¡Œ
            
            vscode.postMessage({
                command: 'loadMore',
                startLine: currentLoaded,
                count: toLoad
            });
        }
        
        function showLoadMoreHint() {
            // åœ¨é¡µé¢åº•éƒ¨æ˜¾ç¤ºåŠ è½½æ›´å¤šæŒ‰é’®
            const pagination = document.getElementById('pagination');
            let loadMoreBtn = document.getElementById('loadMoreBtn');
            
            if (!loadMoreBtn) {
                loadMoreBtn = document.createElement('button');
                loadMoreBtn.id = 'loadMoreBtn';
                loadMoreBtn.style.backgroundColor = '#0e7490';
                loadMoreBtn.style.marginLeft = '20px';
                loadMoreBtn.innerHTML = 'ğŸ“‚ åŠ è½½æ›´å¤šæ•°æ®';
                loadMoreBtn.onclick = function() {
                    loadAllRemainingData();
                };
                pagination.appendChild(loadMoreBtn);
            }
            
            loadMoreBtn.style.display = allDataLoaded ? 'none' : 'inline-block';
        }
        
        function loadAllRemainingData() {
            if (allDataLoaded) return;
            
            const remaining = totalLinesInFile - allLines.length;
            if (remaining <= 0) {
                allDataLoaded = true;
                return;
            }
            
            vscode.postMessage({
                command: 'loadMore',
                startLine: allLines.length,
                count: remaining
            });
            
            // éšè—åŠ è½½æŒ‰é’®
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            if (loadMoreBtn) {
                loadMoreBtn.style.display = 'none';
            }
        }
        
        function goToFirstPage() {
            currentPage = 1;
            updatePagination();
            renderLines();
        }
        
        function goToPrevPage() {
            if (currentPage > 1) {
                currentPage--;
                updatePagination();
                renderLines();
            }
        }
        
        function goToNextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                updatePagination();
                renderLines();
            }
        }
        
        function goToLastPage() {
            currentPage = totalPages;
            updatePagination();
            renderLines();
        }
        
        function goToPage(page) {
            page = parseInt(page);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                updatePagination();
                renderLines();
            } else {
                document.getElementById('currentPageInput').value = currentPage;
            }
        }
        
        function changePageSize(size) {
            pageSize = parseInt(size);
            currentPage = 1;
            updatePagination();
            renderLines();
        }
        
        // ========== æ—¶é—´çº¿å¯¼èˆªåŠŸèƒ½ ==========
        
        function toggleTimeline() {
            isTimelineExpanded = !isTimelineExpanded;
            const content = document.getElementById('timelineContent');
            const icon = document.getElementById('timelineToggleIcon');
            
            if (isTimelineExpanded) {
                content.style.display = 'block';
                icon.textContent = 'â–¼';
            } else {
                content.style.display = 'none';
                icon.textContent = 'â–¶';
            }
        }
        
        function generateTimeline() {
            console.log('ğŸ“Š å¼€å§‹ç”Ÿæˆæ—¶é—´çº¿ï¼ŒallLines æ•°é‡:', allLines.length);
            
            // ä»allLinesä¸­æå–æ—¶é—´æˆ³
            const timestamps = [];
            const levelCounts = { ERROR: [], WARN: [], INFO: [], DEBUG: [], OTHER: [] };
            
            for (let line of allLines) {
                if (line.timestamp) {
                    timestamps.push(new Date(line.timestamp));
                }
            }
            
            console.log('ğŸ“Š æå–åˆ°çš„æ—¶é—´æˆ³æ•°é‡:', timestamps.length);
            
            // å¦‚æœæ²¡æœ‰æ—¶é—´æˆ³ï¼Œéšè—æ—¶é—´çº¿
            if (timestamps.length === 0) {
                console.log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°æ—¶é—´æˆ³ï¼Œéšè—æ—¶é—´çº¿');
                document.getElementById('timelinePanel').style.display = 'none';
                return;
            }
            
            // æ‰¾å‡ºæ—¶é—´èŒƒå›´
            timestamps.sort((a, b) => a - b);
            const startTime = timestamps[0];
            const endTime = timestamps[timestamps.length - 1];
            const timeRange = endTime - startTime;
            
            console.log('ğŸ“Š æ—¶é—´èŒƒå›´:', startTime.toLocaleString(), '-', endTime.toLocaleString(), 'ï¼ŒèŒƒå›´:', timeRange, 'ms');
            
            // å¦‚æœæ—¶é—´èŒƒå›´å¤ªå°ï¼ˆæ¯”å¦‚éƒ½æ˜¯åŒä¸€ç§’ï¼‰ï¼Œä¸æ˜¾ç¤ºæ—¶é—´çº¿
            if (timeRange < 1000) { // å°äº1ç§’
                console.log('âš ï¸ æ—¶é—´èŒƒå›´å¤ªå°ï¼Œéšè—æ—¶é—´çº¿');
                document.getElementById('timelinePanel').style.display = 'none';
                return;
            }
            
            // å°†æ—¶é—´åˆ†æˆè‹¥å¹²ä¸ªæ¡¶ï¼ˆbucketï¼‰
            const bucketCount = 50; // æ—¶é—´çº¿åˆ†æˆ50æ®µ
            const bucketSize = timeRange / bucketCount;
            const buckets = new Array(bucketCount).fill(0);
            const bucketLevels = new Array(bucketCount).fill(null).map(() => ({ ERROR: 0, WARN: 0, INFO: 0, DEBUG: 0, OTHER: 0 }));
            
            // ç»Ÿè®¡æ¯ä¸ªæ¡¶çš„æ—¥å¿—æ•°é‡å’Œçº§åˆ«åˆ†å¸ƒ
            for (let line of allLines) {
                if (line.timestamp) {
                    const time = new Date(line.timestamp);
                    const bucketIndex = Math.min(Math.floor((time - startTime) / bucketSize), bucketCount - 1);
                    buckets[bucketIndex]++;
                    
                    const level = (line.level || 'OTHER').toUpperCase();
                    if (bucketLevels[bucketIndex][level] !== undefined) {
                        bucketLevels[bucketIndex][level]++;
                    } else {
                        bucketLevels[bucketIndex]['OTHER']++;
                    }
                }
            }
            
            // ä¿å­˜æ—¶é—´çº¿æ•°æ®
            timelineData = {
                startTime,
                endTime,
                timeRange,
                buckets,
                bucketLevels,
                bucketSize,
                bucketCount
            };
            
            console.log('âœ… æ—¶é—´çº¿æ•°æ®ç”Ÿæˆå®Œæˆï¼Œå‡†å¤‡ç»˜åˆ¶');
            
            // æ˜¾ç¤ºæ—¶é—´çº¿é¢æ¿
            document.getElementById('timelinePanel').style.display = 'block';
            
            // æ›´æ–°æ—¶é—´ä¿¡æ¯
            const info = document.getElementById('timelineInfo');
            info.innerHTML = `ğŸ“… ${startTime.toLocaleString()} â€” ${endTime.toLocaleString()} <span style="margin-left: 15px;">ğŸ“Š å…± ${timestamps.length} æ¡æœ‰æ—¶é—´æˆ³çš„æ—¥å¿—</span>`;
            
            // å»¶è¿Ÿç»˜åˆ¶ï¼Œç¡®ä¿Canvaså…ƒç´ å·²ç»æ¸²æŸ“å¥½
            setTimeout(() => {
                drawTimeline();
            }, 100);
        }
        
        function drawTimeline() {
            if (!timelineData) {
                console.log('âš ï¸ drawTimeline: timelineData ä¸ºç©º');
                return;
            }
            
            const canvas = document.getElementById('timelineCanvas');
            if (!canvas) {
                console.log('âš ï¸ drawTimeline: æ‰¾ä¸åˆ° canvas å…ƒç´ ');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.log('âš ï¸ drawTimeline: æ— æ³•è·å– 2d context');
                return;
            }
            
            // è®¾ç½®canvaså®é™…å°ºå¯¸ï¼ˆé«˜åˆ†è¾¨ç‡ï¼‰
            const rect = canvas.getBoundingClientRect();
            
            // ç¡®ä¿canvasæœ‰æœ‰æ•ˆå°ºå¯¸
            if (rect.width === 0 || rect.height === 0) {
                console.log('âš ï¸ drawTimeline: canvas å°ºå¯¸ä¸º0ï¼Œç­‰å¾…æ¸²æŸ“...');
                // å†æ¬¡å»¶è¿Ÿå°è¯•
                setTimeout(() => drawTimeline(), 200);
                return;
            }
            
            console.log('ğŸ¨ å¼€å§‹ç»˜åˆ¶æ—¶é—´çº¿ï¼Œcanvas å°ºå¯¸:', rect.width, 'x', rect.height);
            
            canvas.width = rect.width * 2;
            canvas.height = 160;
            ctx.scale(2, 2);
            
            const width = rect.width;
            const height = 80;
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, width, height);
            
            // æ‰¾å‡ºæœ€å¤§å€¼ç”¨äºå½’ä¸€åŒ–
            const maxCount = Math.max(...timelineData.buckets, 1);
            
            // è®¡ç®—æ¯ä¸ªæŸ±å­çš„å®½åº¦
            const barWidth = width / timelineData.bucketCount;
            
            console.log('ğŸ¨ ç»˜åˆ¶å‚æ•° - æœ€å¤§å€¼:', maxCount, 'ï¼ŒæŸ±å®½:', barWidth);
            
            // ç»˜åˆ¶æŸ±çŠ¶å›¾
            for (let i = 0; i < timelineData.bucketCount; i++) {
                const count = timelineData.buckets[i];
                const barHeight = (count / maxCount) * (height - 10);
                const x = i * barWidth;
                const y = height - barHeight;
                
                // æ ¹æ®çº§åˆ«åˆ†å¸ƒå†³å®šé¢œè‰²
                const levels = timelineData.bucketLevels[i];
                let color = '#888888'; // é»˜è®¤ç°è‰²
                
                if (levels.ERROR > 0) {
                    color = '#f14c4c'; // çº¢è‰² - ERROR
                } else if (levels.WARN > 0) {
                    color = '#cca700'; // æ©™è‰² - WARN
                } else if (levels.INFO > 0) {
                    color = '#4fc1ff'; // è“è‰² - INFO
                } else if (levels.DEBUG > 0) {
                    color = '#b267e6'; // ç´«è‰² - DEBUG
                }
                
                // ç»˜åˆ¶æŸ±å­
                ctx.fillStyle = color;
                ctx.fillRect(x, y, Math.max(barWidth - 1, 1), barHeight);
            }
            
            console.log('âœ… æ—¶é—´çº¿ç»˜åˆ¶å®Œæˆ');
        }
        
        // ç‚¹å‡»æ—¶é—´çº¿è·³è½¬
        document.getElementById('timelineCanvas').addEventListener('click', function(e) {
            if (!timelineData) return;
            
            const canvas = this;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const clickRatio = x / rect.width;
            
            // è®¡ç®—ç‚¹å‡»ä½ç½®å¯¹åº”çš„æ—¶é—´
            const targetTime = new Date(timelineData.startTime.getTime() + clickRatio * timelineData.timeRange);
            
            console.log('ğŸ• æ—¶é—´çº¿ç‚¹å‡» - ç›®æ ‡æ—¶é—´:', targetTime.toLocaleString());
            
            // åœ¨å·²åŠ è½½çš„æ•°æ®ä¸­æŸ¥æ‰¾æœ€æ¥è¿‘çš„è¡Œ
            let closestIndex = -1;
            let minDiff = Infinity;
            
            for (let i = 0; i < allLines.length; i++) {
                if (allLines[i].timestamp) {
                    const lineTime = new Date(allLines[i].timestamp);
                    const diff = Math.abs(lineTime - targetTime);
                    if (diff < minDiff) {
                        minDiff = diff;
                        closestIndex = i;
                    }
                }
            }
            
            if (closestIndex !== -1) {
                // è·³è½¬åˆ°å¯¹åº”é¡µé¢
                const targetPage = Math.floor(closestIndex / pageSize) + 1;
                currentPage = targetPage;
                updatePagination();
                renderLines();
                
                // æ»šåŠ¨åˆ°é¡¶éƒ¨
                document.getElementById('logContainer').scrollTop = 0;
                
                showToast(`å·²è·³è½¬åˆ° ${new Date(allLines[closestIndex].timestamp).toLocaleString()}`);
            } else {
                showToast('âš ï¸ è¯¥æ—¶é—´æ®µæ²¡æœ‰æ—¥å¿—æ•°æ®');
            }
        });
        
        // é¼ æ ‡æ‚¬åœæ˜¾ç¤ºæ—¶é—´ä¿¡æ¯
        document.getElementById('timelineCanvas').addEventListener('mousemove', function(e) {
            if (!timelineData) return;
            
            const canvas = this;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const hoverRatio = x / rect.width;
            
            // è®¡ç®—æ‚¬åœä½ç½®å¯¹åº”çš„æ—¶é—´
            const hoverTime = new Date(timelineData.startTime.getTime() + hoverRatio * timelineData.timeRange);
            
            // æ‰¾åˆ°å¯¹åº”çš„æ¡¶
            const bucketIndex = Math.min(Math.floor(hoverRatio * timelineData.bucketCount), timelineData.bucketCount - 1);
            const count = timelineData.buckets[bucketIndex];
            const levels = timelineData.bucketLevels[bucketIndex];
            
            // æ›´æ–°æ ‡é¢˜æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
            canvas.title = `${hoverTime.toLocaleString()}\næ—¥å¿—æ•°: ${count}\nERROR: ${levels.ERROR} | WARN: ${levels.WARN} | INFO: ${levels.INFO} | DEBUG: ${levels.DEBUG}`;
        });
        
        // æœç´¢æ¡†å›è½¦æœç´¢
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                search();
            }
        });
        
        // ========== JSON/XML è‡ªåŠ¨è§£æåŠŸèƒ½ ==========
        
        function detectAndParseStructuredData(content) {
            if (!content || typeof content !== 'string') return null;
            
            // å°è¯•æ£€æµ‹JSON
            const jsonMatch = content.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
            if (jsonMatch) {
                try {
                    const jsonStr = jsonMatch[0];
                    const jsonObj = JSON.parse(jsonStr);
                    return renderJSONTree(jsonObj);
                } catch (e) {
                    // ä¸æ˜¯æœ‰æ•ˆçš„JSON
                }
            }
            
            // å°è¯•æ£€æµ‹XML
            const xmlMatch = content.match(/<[^>]+>[\s\S]*<\/[^>]+>/);
            if (xmlMatch) {
                try {
                    const xmlStr = xmlMatch[0];
                    return renderXMLTree(xmlStr);
                } catch (e) {
                    // ä¸æ˜¯æœ‰æ•ˆçš„XML
                }
            }
            
            return null;
        }
        
        function renderJSONTree(obj, depth = 0) {
            const id = 'json_' + Math.random().toString(36).substr(2, 9);
            
            if (obj === null) {
                return `<span class="json-null">null</span>`;
            }
            
            if (typeof obj === 'string') {
                return `<span class="json-string">"${escapeHtml(obj)}"</span>`;
            }
            
            if (typeof obj === 'number') {
                return `<span class="json-number">${obj}</span>`;
            }
            
            if (typeof obj === 'boolean') {
                return `<span class="json-boolean">${obj}</span>`;
            }
            
            const isArray = Array.isArray(obj);
            const keys = Object.keys(obj);
            const len = keys.length;
            
            if (len === 0) {
                return isArray ? '<span>[]</span>' : '<span>{}</span>';
            }
            
            // å¦‚æœå¯¹è±¡å¤ªå¤§ï¼Œé»˜è®¤æŠ˜å 
            const defaultCollapsed = depth > 1 || len > 10;
            
            let html = '<div class="json-tree">';
            html += `<span class="json-tree-toggle" onclick="toggleJSONNode('${id}')">${defaultCollapsed ? 'â–¶' : 'â–¼'}</span>`;
            html += `<span>${isArray ? '[' : '{'}</span>`;
            html += `<span class="json-expand-btn" onclick="toggleJSONNode('${id}')" style="display:${defaultCollapsed ? 'inline-block' : 'none'}" id="${id}_btn">${len} items</span>`;
            
            html += `<div id="${id}" class="json-tree-item${defaultCollapsed ? ' json-tree-collapsed' : ''}">`;
            
            keys.forEach((key, index) => {
                const value = obj[key];
                const isLast = index === len - 1;
                
                html += '<div style="margin-left: 15px;">';
                
                if (!isArray) {
                    html += `<span class="json-key">"${escapeHtml(key)}"</span>: `;
                }
                
                if (typeof value === 'object' && value !== null) {
                    html += renderJSONTree(value, depth + 1);
                } else {
                    html += renderJSONTree(value, depth + 1);
                }
                
                if (!isLast) {
                    html += ',';
                }
                
                html += '</div>';
            });
            
            html += '</div>';
            html += `<span>${isArray ? ']' : '}'}</span>`;
            html += '</div>';
            
            return html;
        }
        
        function renderXMLTree(xmlStr) {
            const id = 'xml_' + Math.random().toString(36).substr(2, 9);
            
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlStr, 'text/xml');
                
                if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                    return null;
                }
                
                return renderXMLNode(xmlDoc.documentElement, 0);
            } catch (e) {
                return null;
            }
        }
        
        function renderXMLNode(node, depth = 0) {
            if (!node) return '';
            
            const id = 'xml_' + Math.random().toString(36).substr(2, 9);
            const tagName = node.tagName;
            const hasChildren = node.children.length > 0;
            const hasText = node.childNodes.length === 1 && node.childNodes[0].nodeType === 3;
            
            // é»˜è®¤æŠ˜å æ·±åº¦>1çš„èŠ‚ç‚¹
            const defaultCollapsed = depth > 1;
            
            let html = '<div class="xml-tree">';
            
            if (hasChildren) {
                html += `<span class="xml-tree-toggle" onclick="toggleXMLNode('${id}')">${defaultCollapsed ? 'â–¶' : 'â–¼'}</span>`;
            } else {
                html += '<span style="display:inline-block;width:14px;"></span>';
            }
            
            // å¼€å§‹æ ‡ç­¾
            html += '<span class="xml-tag">&lt;' + escapeHtml(tagName);
            
            // å±æ€§
            if (node.attributes) {
                for (let i = 0; i < node.attributes.length; i++) {
                    const attr = node.attributes[i];
                    html += ' <span class="xml-attr-name">' + escapeHtml(attr.name) + '</span>=';
                    html += '<span class="xml-attr-value">"' + escapeHtml(attr.value) + '"</span>';
                }
            }
            
            if (!hasChildren && !hasText) {
                html += '/&gt;</span>';
            } else {
                html += '&gt;</span>';
                
                if (hasText) {
                    html += escapeHtml(node.textContent.trim());
                } else if (hasChildren) {
                    html += `<div id="${id}" class="xml-tree-item${defaultCollapsed ? ' xml-tree-collapsed' : ''}">`;
                    
                    for (let i = 0; i < node.children.length; i++) {
                        html += renderXMLNode(node.children[i], depth + 1);
                    }
                    
                    html += '</div>';
                }
                
                html += '<span class="xml-tag">&lt;/' + escapeHtml(tagName) + '&gt;</span>';
            }
            
            html += '</div>';
            
            return html;
        }
        
        function toggleJSONNode(id) {
            const node = document.getElementById(id);
            const toggle = node.previousElementSibling.previousElementSibling;
            const btn = document.getElementById(id + '_btn');
            
            if (node.classList.contains('json-tree-collapsed')) {
                node.classList.remove('json-tree-collapsed');
                toggle.textContent = 'â–¼';
                if (btn) btn.style.display = 'none';
            } else {
                node.classList.add('json-tree-collapsed');
                toggle.textContent = 'â–¶';
                if (btn) btn.style.display = 'inline-block';
            }
        }
        
        function toggleXMLNode(id) {
            const node = document.getElementById(id);
            const toggle = node.previousElementSibling.previousElementSibling;
            
            if (node.classList.contains('xml-tree-collapsed')) {
                node.classList.remove('xml-tree-collapsed');
                toggle.textContent = 'â–¼';
            } else {
                node.classList.add('xml-tree-collapsed');
                toggle.textContent = 'â–¶';
            }
        }
        
        // ========== å»é‡ç»Ÿè®¡åŠŸèƒ½ ==========
        
        function showDeduplicationStats() {
            document.getElementById('deduplicationModal').style.display = 'block';
            analyzeDeduplication(85);
        }
        
        function closeDeduplicationModal() {
            document.getElementById('deduplicationModal').style.display = 'none';
        }
        
        function reanalyzeDeduplication() {
            const threshold = parseInt(document.getElementById('similarityThreshold').value);
            analyzeDeduplication(threshold);
        }
        
        function analyzeDeduplication(similarityThreshold = 85) {
            const resultDiv = document.getElementById('deduplicationResult');
            resultDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--vscode-descriptionForeground);">ğŸ” æ­£åœ¨åˆ†ææ—¥å¿—æ¨¡å¼...</div>';
            
            // å»¶è¿Ÿæ‰§è¡Œï¼Œæ˜¾ç¤ºåŠ è½½æ•ˆæœ
            setTimeout(() => {
                const patterns = findSimilarLogPatterns(allLines, similarityThreshold / 100);
                displayDeduplicationResults(patterns);
            }, 100);
        }
        
        function findSimilarLogPatterns(lines, threshold) {
            const patterns = new Map();
            
            lines.forEach((line, index) => {
                const content = (line.content || line).toString();
                
                // æå–æ—¥å¿—æ¨¡å¼ï¼šå°†æ•°å­—ã€æ—¶é—´æˆ³ã€UUIDç­‰å˜é‡æ›¿æ¢ä¸ºå ä½ç¬¦
                let pattern = normalizeLogPattern(content);
                
                if (!patterns.has(pattern)) {
                    patterns.set(pattern, {
                        pattern: pattern,
                        count: 0,
                        level: line.level || 'OTHER',
                        examples: [],
                        lineNumbers: []
                    });
                }
                
                const patternData = patterns.get(pattern);
                patternData.count++;
                patternData.lineNumbers.push(line.lineNumber || index + 1);
                
                // åªä¿å­˜3ä¸ªç¤ºä¾‹
                if (patternData.examples.length < 3) {
                    patternData.examples.push({
                        lineNumber: line.lineNumber || index + 1,
                        content: content
                    });
                }
            });
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰å‡ºç°æ¬¡æ•°æ’åº
            const sortedPatterns = Array.from(patterns.values())
                .filter(p => p.count >= 2) // åªæ˜¾ç¤ºè‡³å°‘å‡ºç°äº†ä¸¤æ¬¡çš„æ¨¡å¼
                .sort((a, b) => b.count - a.count);
            
            return sortedPatterns;
        }
        
        function normalizeLogPattern(content) {
            let pattern = content;
            
            // æ›¿æ¢æ—¶é—´æˆ³
            pattern = pattern.replace(/\d{4}[-\/]\d{2}[-\/]\d{2}[T\s]\d{2}:\d{2}:\d{2}(\.\d+)?/g, '<TIMESTAMP>');
            pattern = pattern.replace(/\[\d{4}[-\/]\d{2}[-\/]\d{2}[T\s]\d{2}:\d{2}:\d{2}(\.\d+)?\]/g, '[<TIMESTAMP>]');
            
            // æ›¿æ¢UUID
            pattern = pattern.replace(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/gi, '<UUID>');
            
            // æ›¿æ¢IPåœ°å€
            pattern = pattern.replace(/\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b/g, '<IP>');
            
            // æ›¿æ¢ç«¯å£å·
            pattern = pattern.replace(/:(\d{2,5})\b/g, ':<PORT>');
            
            // æ›¿æ¢æ•´æ•°ï¼ˆè¿ç»­3ä½ä»¥ä¸Šï¼‰
            pattern = pattern.replace(/\b\d{3,}\b/g, '<NUMBER>');
            
            // æ›¿æ¢æµ®ç‚¹æ•°
            pattern = pattern.replace(/\b\d+\.\d+\b/g, '<DECIMAL>');
            
            // æ›¿æ¢åå…­è¿›åˆ¶æ•°ï¼ˆå¦‚å†…å­˜åœ°å€ï¼‰
            pattern = pattern.replace(/0x[0-9a-fA-F]+/g, '<HEX>');
            
            // æ›¿æ¢æ–‡ä»¶è·¯å¾„
            pattern = pattern.replace(/[A-Za-z]:\\[^\s]+/g, '<FILEPATH>');
            pattern = pattern.replace(/\/[a-zA-Z0-9_\-\/\.]+/g, '<PATH>');
            
            // æ›¿æ¢å•ç‹¬çš„æ•°å­—ï¼ˆä¸è¶³ä¸‰ä½ï¼‰
            pattern = pattern.replace(/\b\d{1,2}\b/g, '<NUM>');
            
            return pattern;
        }
        
        function displayDeduplicationResults(patterns) {
            const resultDiv = document.getElementById('deduplicationResult');
            
            if (patterns.length === 0) {
                resultDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--vscode-descriptionForeground);">
                        âœ… æ²¡æœ‰å‘ç°é‡å¤çš„æ—¥å¿—æ¨¡å¼ï¼<br>
                        <span style="font-size: 12px; margin-top: 10px; display: block;">æ‰€æœ‰æ—¥å¿—éƒ½æ˜¯å”¯ä¸€çš„ï¼Œæˆ–è€…ç›¸ä¼¼åº¦æœªè¾¾åˆ°é˜ˆå€¼</span>
                    </div>
                `;
                return;
            }
            
            const totalDuplicates = patterns.reduce((sum, p) => sum + p.count, 0);
            const uniquePatterns = patterns.length;
            
            let html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 5px; margin-bottom: 15px; color: white;">
                    <div style="display: flex; justify-content: space-around; text-align: center;">
                        <div>
                            <div style="font-size: 28px; font-weight: bold;">${uniquePatterns}</div>
                            <div style="font-size: 12px; opacity: 0.9; margin-top: 5px;">ç›¸ä¼¼æ¨¡å¼</div>
                        </div>
                        <div>
                            <div style="font-size: 28px; font-weight: bold;">${totalDuplicates}</div>
                            <div style="font-size: 12px; opacity: 0.9; margin-top: 5px;">æ€»é‡å¤æ¬¡æ•°</div>
                        </div>
                        <div>
                            <div style="font-size: 28px; font-weight: bold;">${((totalDuplicates / allLines.length) * 100).toFixed(1)}%</div>
                            <div style="font-size: 12px; opacity: 0.9; margin-top: 5px;">é‡å¤æ¯”ä¾‹</div>
                        </div>
                    </div>
                </div>
            `;
            
            patterns.forEach((p, index) => {
                const levelColor = {
                    'ERROR': '#f14c4c',
                    'WARN': '#cca700',
                    'INFO': '#4fc1ff',
                    'DEBUG': '#b267e6',
                    'OTHER': '#888888'
                }[p.level.toUpperCase()] || '#888888';
                
                const isExpanded = index < 5; // å‰5ä¸ªé»˜è®¤å±•å¼€
                const patternId = 'pattern_' + index;
                
                html += `
                    <div style="margin-bottom: 15px; border: 1px solid var(--vscode-panel-border); border-radius: 5px; overflow: hidden;">
                        <div style="background-color: var(--vscode-editorWidget-background); padding: 12px; cursor: pointer;" 
                             onclick="togglePattern('${patternId}')">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                    <span id="${patternId}_toggle" style="font-weight: bold; color: var(--vscode-textLink-foreground);">${isExpanded ? 'â–¼' : 'â–¶'}</span>
                                    <span style="width: 8px; height: 8px; border-radius: 50%; background-color: ${levelColor};"></span>
                                    <span style="font-weight: bold; color: var(--vscode-textLink-foreground);">#${index + 1}</span>
                                    <span style="font-size: 12px; color: var(--vscode-descriptionForeground); font-family: 'Consolas', monospace; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        ${escapeHtml(p.pattern.substring(0, 100))}${p.pattern.length > 100 ? '...' : ''}
                                    </span>
                                </div>
                                <div style="display: flex; gap: 15px; align-items: center;">
                                    <span style="background-color: ${levelColor}; color: white; padding: 3px 8px; border-radius: 3px; font-size: 11px; font-weight: bold;">
                                        ${p.level}
                                    </span>
                                    <span style="background-color: #8b5cf6; color: white; padding: 3px 10px; border-radius: 3px; font-size: 12px; font-weight: bold;">
                                        ${p.count} æ¬¡
                                    </span>
                                    <button onclick="event.stopPropagation(); showPatternLines(${JSON.stringify(p.lineNumbers).replace(/"/g, '&quot;')})"
                                            style="padding: 3px 10px; font-size: 11px; background-color: #10b981;">
                                        ğŸ” æŸ¥çœ‹æ‰€æœ‰
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="${patternId}" style="display: ${isExpanded ? 'block' : 'none'}; padding: 15px; background-color: var(--vscode-editor-background);">
                            <div style="margin-bottom: 10px; font-weight: bold; color: var(--vscode-textLink-foreground);">ğŸ“Š æ¨¡å¼è¯¦æƒ…ï¼š</div>
                            <div style="background-color: var(--vscode-editorWidget-background); padding: 10px; border-radius: 3px; font-family: 'Consolas', monospace; font-size: 11px; line-height: 1.6; word-wrap: break-word; margin-bottom: 15px;">
                                ${escapeHtml(p.pattern)}
                            </div>
                            <div style="margin-bottom: 10px; font-weight: bold; color: var(--vscode-textLink-foreground);">ğŸ“ ç¤ºä¾‹ï¼ˆå‰3æ¡ï¼‰ï¼š</div>
                            ${p.examples.map(ex => `
                                <div style="padding: 8px; margin-bottom: 8px; background-color: var(--vscode-editorWidget-background); border-radius: 3px; border-left: 3px solid ${levelColor}; cursor: pointer; transition: background-color 0.2s;"
                                     onmouseover="this.style.backgroundColor='var(--vscode-list-hoverBackground)'"
                                     onmouseout="this.style.backgroundColor='var(--vscode-editorWidget-background)'"
                                     onclick="jumpToLineInPattern(${ex.lineNumber})"
                                     title="ç‚¹å‡»è·³è½¬åˆ°è¯¥è¡Œ">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span style="font-size: 11px; color: var(--vscode-descriptionForeground);">è¡Œ ${ex.lineNumber}</span>
                                    </div>
                                    <div style="font-family: 'Consolas', monospace; font-size: 11px; color: var(--vscode-editor-foreground); word-wrap: break-word;">
                                        ${escapeHtml(ex.content)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            resultDiv.innerHTML = html;
        }
        
        function togglePattern(patternId) {
            const content = document.getElementById(patternId);
            const toggle = document.getElementById(patternId + '_toggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = 'â–¼';
            } else {
                content.style.display = 'none';
                toggle.textContent = 'â–¶';
            }
        }
        
        function showPatternLines(lineNumbers) {
            // æŒ‰è¡Œå·ç­›é€‰å¹¶æ˜¾ç¤º
            const filteredLines = allLines.filter(line => {
                const lineNum = line.lineNumber || allLines.indexOf(line) + 1;
                return lineNumbers.includes(lineNum);
            });
            
            closeDeduplicationModal();
            
            // æ˜¾ç¤ºç­›é€‰åçš„æ—¥å¿—
            allLines = filteredLines;
            currentPage = 1;
            isFiltering = true;
            updatePagination();
            renderLines();
            
            showToast(`âœ… å·²ç­›é€‰å‡º ${filteredLines.length} æ¡ç›¸ä¼¼æ—¥å¿—`);
        }
        
        function jumpToLineInPattern(lineNumber) {
            closeDeduplicationModal();
            
            // å¦‚æœå½“å‰æ˜¯è¿‡æ»¤æ¨¡å¼ï¼Œå…ˆæ¢å¤å®Œæ•´æ—¥å¿—
            if (isFiltering || currentSearchKeyword) {
                jumpToLineInFullLog(lineNumber);
            } else {
                jumpToLine(lineNumber);
            }
        }
        
        // é”®ç›˜å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', function(e) {
            // ä¸åœ¨è¾“å…¥æ¡†ä¸­æ—¶æ‰å“åº”
            if (e.target.tagName === 'INPUT') return;
            
            if (e.key === 'ArrowLeft' || e.key === 'PageUp') {
                e.preventDefault();
                goToPrevPage();
            } else if (e.key === 'ArrowRight' || e.key === 'PageDown') {
                e.preventDefault();
                goToNextPage();
            } else if (e.key === 'Home') {
                e.preventDefault();
                goToFirstPage();
            } else if (e.key === 'End') {
                e.preventDefault();
                goToLastPage();
            }
        });
    </script>
</body>
</html>
