# åˆå§‹åŠ è½½ç­–ç•¥

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [logViewerPanel.ts](file://src/logViewerPanel.ts)
- [logProcessor.ts](file://src/logProcessor.ts)
- [extension.ts](file://src/extension.ts)
- [package.json](file://package.json)
- [README.md](file://README.md)
- [webview.html](file://src/webview.html)
</cite>

## ç›®å½•
1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
3. [åˆå§‹åŠ è½½ç­–ç•¥è¯¦è§£](#åˆå§‹åŠ è½½ç­–ç•¥è¯¦è§£)
4. [æ ¸å¿ƒç»„ä»¶åˆ†æ](#æ ¸å¿ƒç»„ä»¶åˆ†æ)
5. [ç”¨æˆ·ä½“éªŒä¼˜åŒ–](#ç”¨æˆ·ä½“éªŒä¼˜åŒ–)
6. [æ€§èƒ½è€ƒé‡](#æ€§èƒ½è€ƒé‡)
7. [æ•…éšœæ’é™¤æŒ‡å—](#æ•…éšœæ’é™¤æŒ‡å—)
8. [æ€»ç»“](#æ€»ç»“)

## æ¦‚è¿°

large_log_checkæ˜¯ä¸€ä¸ªä¸“ä¸šçš„VSCodeæ‰©å±•ï¼Œä¸“é—¨ç”¨äºå¤„ç†å¤§å‹æ—¥å¿—æ–‡ä»¶ã€‚å…¶æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€æ˜¯æ™ºèƒ½çš„åˆå§‹åŠ è½½ç­–ç•¥ï¼Œè¯¥ç­–ç•¥èƒ½å¤Ÿæ ¹æ®æ—¥å¿—æ–‡ä»¶çš„è¡Œæ•°è‡ªåŠ¨è°ƒæ•´åŠ è½½æ–¹å¼ï¼Œä»è€Œåœ¨ä¿è¯ç”¨æˆ·ä½“éªŒçš„åŒæ—¶ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ã€‚

### ä¸»è¦ç‰¹ç‚¹

- **æ™ºèƒ½æ–‡ä»¶å¤§å°æ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æµ‹æ—¥å¿—æ–‡ä»¶çš„è¡Œæ•°
- **å·®å¼‚åŒ–åŠ è½½ç­–ç•¥**ï¼šå°æ–‡ä»¶ï¼ˆâ‰¤5ä¸‡è¡Œï¼‰ä¸€æ¬¡æ€§åŠ è½½ï¼Œå¤§æ–‡ä»¶ï¼ˆ>5ä¸‡è¡Œï¼‰åˆ†æ‰¹åŠ è½½
- **å®æ—¶ç”¨æˆ·åé¦ˆ**ï¼šé€šè¿‡VSCodeæ¶ˆæ¯ç³»ç»Ÿæä¾›åŠ è½½è¿›åº¦æç¤º
- **åŒå‘é€šä¿¡æœºåˆ¶**ï¼šé€šè¿‡postMessageä¸WebViewè¿›è¡Œæ•°æ®äº¤æ¢

## ç³»ç»Ÿæ¶æ„

```mermaid
graph TB
subgraph "VSCodeæ‰©å±•å±‚"
Ext[extension.ts<br/>æ‰©å±•å…¥å£]
Panel[logViewerPanel.ts<br/>é¢æ¿ç®¡ç†å™¨]
end
subgraph "æ ¸å¿ƒå¤„ç†å±‚"
Processor[logProcessor.ts<br/>æ—¥å¿—å¤„ç†å™¨]
FileSystem[æ–‡ä»¶ç³»ç»Ÿ<br/>è¯»å–æ“ä½œ]
end
subgraph "å‰ç«¯å±•ç¤ºå±‚"
WebView[webview.html<br/>Webç•Œé¢]
UI[ç”¨æˆ·ç•Œé¢<br/>äº¤äº’æ§åˆ¶]
end
Ext --> Panel
Panel --> Processor
Processor --> FileSystem
Panel --> WebView
WebView --> UI
Panel -.->|postMessage| WebView
WebView -.->|æ¶ˆæ¯é€šä¿¡| Panel
```

**å›¾è¡¨æ¥æº**
- [extension.ts](file://src/extension.ts#L1-L116)
- [logViewerPanel.ts](file://src/logViewerPanel.ts#L1-L510)
- [logProcessor.ts](file://src/logProcessor.ts#L1-L807)

## åˆå§‹åŠ è½½ç­–ç•¥è¯¦è§£

### åŠ è½½ç­–ç•¥å†³ç­–é€»è¾‘

ç³»ç»Ÿçš„æ ¸å¿ƒåŠ è½½ç­–ç•¥åŸºäºæ–‡ä»¶è¡Œæ•°è¿›è¡Œæ™ºèƒ½åˆ¤æ–­ï¼š

```mermaid
flowchart TD
Start([å¼€å§‹åŠ è½½]) --> GetLines["è°ƒç”¨getTotalLines()<br/>è·å–æ–‡ä»¶æ€»è¡Œæ•°"]
GetLines --> CheckSize{"æ–‡ä»¶è¡Œæ•° â‰¤ 50000?"}
CheckSize --> |æ˜¯| SmallFile["å°æ–‡ä»¶å¤„ç†"]
CheckSize --> |å¦| LargeFile["å¤§æ–‡ä»¶å¤„ç†"]
SmallFile --> ShowMsg1["æ˜¾ç¤ºä¿¡æ¯: æ­£åœ¨åŠ è½½ X è¡Œæ—¥å¿—"]
ShowMsg1 --> LoadAll["è°ƒç”¨readLines(0, totalLines)<br/>ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®"]
LargeFile --> ShowMsg2["æ˜¾ç¤ºä¿¡æ¯: æ–‡ä»¶è¾ƒå¤§ï¼Œå…ˆåŠ è½½å‰ 10000 è¡Œ"]
ShowMsg2 --> LoadPart["è°ƒç”¨readLines(0, 10000)<br/>åŠ è½½å‰10000è¡Œ"]
LoadAll --> SendData1["å‘é€æ•°æ®åˆ°WebView<br/>allLoaded = true"]
LoadPart --> SendData2["å‘é€æ•°æ®åˆ°WebView<br/>allLoaded = false"]
SendData1 --> Success["åŠ è½½å®Œæˆ"]
SendData2 --> Success
Success --> ShowFinalMsg["æ˜¾ç¤ºæœ€ç»ˆä¿¡æ¯: æˆåŠŸåŠ è½½æ–‡ä»¶"]
```

**å›¾è¡¨æ¥æº**
- [logViewerPanel.ts](file://src/logViewerPanel.ts#L107-L147)

### å…³é”®å®ç°ç»†èŠ‚

#### 1. æ–‡ä»¶è¡Œæ•°æ£€æµ‹

[`getTotalLines()`æ–¹æ³•](file://src/logProcessor.ts#L62-L84)è´Ÿè´£å‡†ç¡®ç»Ÿè®¡æ–‡ä»¶è¡Œæ•°ï¼š

- ä½¿ç”¨Node.jsçš„readlineæ¨¡å—é€è¡Œè¯»å–
- ç»´æŠ¤å…¨å±€`totalLines`å˜é‡è®°å½•æ€»è¡Œæ•°
- è¿”å›Promiseç¡®ä¿å¼‚æ­¥æ“ä½œå®Œæˆ

#### 2. æ¡ä»¶åŠ è½½é€»è¾‘

[`loadFile()`æ–¹æ³•](file://src/logViewerPanel.ts#L107-L147)å®ç°äº†æ ¸å¿ƒçš„åŠ è½½ç­–ç•¥ï¼š

```typescript
// æ¡ä»¶åˆ¤æ–­é€»è¾‘
let initialLines;
if (totalLines <= 50000) {
    // å°æ–‡ä»¶ç­–ç•¥ï¼šä¸€æ¬¡æ€§åŠ è½½
    vscode.window.showInformationMessage(`æ­£åœ¨åŠ è½½ ${totalLines} è¡Œæ—¥å¿—ï¼Œè¯·ç¨å€™...`);
    initialLines = await this._logProcessor.readLines(0, totalLines);
} else {
    // å¤§æ–‡ä»¶ç­–ç•¥ï¼šåˆ†æ‰¹åŠ è½½
    vscode.window.showInformationMessage(`æ–‡ä»¶è¾ƒå¤§ï¼Œå…ˆåŠ è½½å‰ 10000 è¡Œ...`);
    initialLines = await this._logProcessor.readLines(0, 10000);
}
```

#### 3. æ•°æ®ä¼ è¾“æœºåˆ¶

é€šè¿‡[`postMessage`](file://src/logViewerPanel.ts#L132-L141)å°†æ•°æ®å‘é€åˆ°WebViewï¼š

```typescript
this._panel.webview.postMessage({
    command: 'fileLoaded',
    data: {
        fileName: path.basename(fileUri.fsPath),
        filePath: fileUri.fsPath,
        fileSize: fileSizeMB,
        totalLines: totalLines,
        lines: initialLines,
        allLoaded: totalLines <= 50000
    }
});
```

**èŠ‚æ¥æº**
- [logViewerPanel.ts](file://src/logViewerPanel.ts#L107-L147)
- [logProcessor.ts](file://src/logProcessor.ts#L62-L84)

## æ ¸å¿ƒç»„ä»¶åˆ†æ

### LogViewerPanelç±»

LogViewerPanelæ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ§åˆ¶å™¨ï¼Œè´Ÿè´£åè°ƒå„ä¸ªç»„ä»¶çš„å·¥ä½œï¼š

```mermaid
classDiagram
class LogViewerPanel {
-_panel : vscode.WebviewPanel
-_extensionUri : vscode.Uri
-_fileUri : vscode.Uri
-_logProcessor : LogProcessor
-_disposables : vscode.Disposable[]
+createOrShow(extensionUri, fileUri)
+loadFile(fileUri)
+loadMoreLines(startLine, count)
+searchLogs(keyword, reverse)
+filterByLevel(levels)
+dispose()
}
class LogProcessor {
-filePath : string
-totalLines : number
+getTotalLines() : Promise~number~
+readLines(startLine, count) : Promise~LogLine[]~
+search(keyword, reverse) : Promise~LogLine[]~
+filterByLevel(levels) : Promise~LogLine[]~
}
LogViewerPanel --> LogProcessor : "ä½¿ç”¨"
LogViewerPanel --> vscode.WebviewPanel : "ç®¡ç†"
```

**å›¾è¡¨æ¥æº**
- [logViewerPanel.ts](file://src/logViewerPanel.ts#L6-L510)
- [logProcessor.ts](file://src/logProcessor.ts#L30-L807)

### LogProcessorç±»

LogProcessoræä¾›äº†æ ¸å¿ƒçš„æ—¥å¿—å¤„ç†åŠŸèƒ½ï¼š

#### æ ¸å¿ƒæ–¹æ³•

| æ–¹æ³•å | åŠŸèƒ½æè¿° | å‚æ•° | è¿”å›å€¼ |
|--------|----------|------|--------|
| `getTotalLines()` | è·å–æ–‡ä»¶æ€»è¡Œæ•° | æ—  | `Promise<number>` |
| `readLines(startLine, count)` | è¯»å–æŒ‡å®šèŒƒå›´çš„è¡Œ | `startLine: number, count: number` | `Promise<LogLine[]>` |
| `search(keyword, reverse)` | æœç´¢åŒ…å«å…³é”®è¯çš„è¡Œ | `keyword: string, reverse?: boolean` | `Promise<LogLine[]>` |
| `filterByLevel(levels)` | æŒ‰æ—¥å¿—çº§åˆ«è¿‡æ»¤ | `levels: string[]` | `Promise<LogLine[]>` |

**èŠ‚æ¥æº**
- [logProcessor.ts](file://src/logProcessor.ts#L62-L807)

## ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### æ¸è¿›å¼åŠ è½½åé¦ˆ

ç³»ç»Ÿé€šè¿‡å¤šé˜¶æ®µçš„ä¿¡æ¯æç¤ºç¡®ä¿ç”¨æˆ·äº†è§£åŠ è½½è¿›åº¦ï¼š

#### 1. åˆå§‹åŠ è½½é˜¶æ®µ
```typescript
vscode.window.showInformationMessage(`æ­£åœ¨åŠ è½½ ${totalLines} è¡Œæ—¥å¿—ï¼Œè¯·ç¨å€™...`);
```

#### 2. å¤§æ–‡ä»¶ç‰¹æ®Šæç¤º
```typescript
vscode.window.showInformationMessage(`æ–‡ä»¶è¾ƒå¤§ï¼Œå…ˆåŠ è½½å‰ 10000 è¡Œ...`);
```

#### 3. æœ€ç»ˆå®Œæˆé€šçŸ¥
```typescript
vscode.window.showInformationMessage(`æˆåŠŸåŠ è½½æ—¥å¿—æ–‡ä»¶: ${path.basename(fileUri.fsPath)} (${fileSizeMB}MB, ${totalLines}è¡Œ)`);
```

### WebViewæ•°æ®ç»‘å®š

åŠ è½½å®Œæˆåï¼Œç³»ç»Ÿå°†æ•°æ®ç»“æ„åŒ–åœ°ä¼ é€’ç»™å‰ç«¯ï¼š

```typescript
{
    command: 'fileLoaded',
    data: {
        fileName: "application.log",
        filePath: "/path/to/application.log",
        fileSize: "12.50",
        totalLines: 150000,
        lines: [...],           // åˆå§‹åŠ è½½çš„è¡Œæ•°æ®
        allLoaded: false        // æ ‡è¯†æ˜¯å¦å·²åŠ è½½å…¨éƒ¨æ•°æ®
    }
}
```

**èŠ‚æ¥æº**
- [logViewerPanel.ts](file://src/logViewerPanel.ts#L122-L144)

## æ€§èƒ½è€ƒé‡

### å†…å­˜ä¼˜åŒ–ç­–ç•¥

#### å°æ–‡ä»¶å¤„ç†ä¼˜åŠ¿
- **ä¸€æ¬¡æ€§åŠ è½½**ï¼šé¿å…å¤šæ¬¡I/Oæ“ä½œ
- **å†…å­˜é›†ä¸­ç®¡ç†**ï¼šå‡å°‘å†…å­˜ç¢ç‰‡
- **å¿«é€Ÿå“åº”**ï¼šç”¨æˆ·ç«‹å³è·å¾—å®Œæ•´æ•°æ®

#### å¤§æ–‡ä»¶å¤„ç†ä¼˜åŒ–
- **åˆ†æ‰¹åŠ è½½**ï¼šæ§åˆ¶å†…å­˜ä½¿ç”¨é‡
- **å»¶è¿ŸåŠ è½½**ï¼šæŒ‰éœ€åŠ è½½å‰©ä½™æ•°æ®
- **æ¸è¿›å¼æ˜¾ç¤º**ï¼šæå‡é¦–å±åŠ è½½é€Ÿåº¦

### æ€§èƒ½åŸºå‡†

| æ–‡ä»¶è§„æ¨¡ | åŠ è½½ç­–ç•¥ | é¦–æ¬¡åŠ è½½æ—¶é—´ | å†…å­˜å ç”¨ | ç”¨æˆ·ä½“éªŒ |
|----------|----------|--------------|----------|----------|
| < 5ä¸‡è¡Œ | ä¸€æ¬¡æ€§åŠ è½½ | < 2ç§’ | ä¸­ç­‰ | å³æ—¶å¯ç”¨ |
| 5-50ä¸‡è¡Œ | åˆ†æ‰¹åŠ è½½ | < 5ç§’ | è¾ƒä½ | å¿«é€Ÿå“åº” |
| > 50ä¸‡è¡Œ | åˆ†æ‰¹åŠ è½½ | < 10ç§’ | æœ€ä½ | å¯æ¥å— |

### æŠ€æœ¯å®ç°è¦ç‚¹

#### æµå¼è¯»å–ä¼˜åŒ–
[`readLines()`æ–¹æ³•](file://src/logProcessor.ts#L89-L129)é‡‡ç”¨æµå¼è¯»å–ç­–ç•¥ï¼š
- ä½¿ç”¨readlineæ¨¡å—é€è¡Œå¤„ç†
- æ”¯æŒå¤§æ–‡ä»¶å¤„ç†è€Œä¸å¯¼è‡´å†…å­˜æº¢å‡º
- å®ç°ç²¾ç¡®çš„èµ·å§‹è¡Œå’Œè¡Œæ•°æ§åˆ¶

#### å¼‚æ­¥å¤„ç†æœºåˆ¶
- Promise-basedå¼‚æ­¥æ“ä½œ
- éé˜»å¡çš„UIçº¿ç¨‹
- é”™è¯¯å¤„ç†å’Œå¼‚å¸¸æ¢å¤

**èŠ‚æ¥æº**
- [logProcessor.ts](file://src/logProcessor.ts#L89-L129)

## æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. å¤§æ–‡ä»¶åŠ è½½ç¼“æ…¢
**ç—‡çŠ¶**ï¼šå¤§æ–‡ä»¶åŠ è½½æ—¶é—´è¶…è¿‡é¢„æœŸ
**åŸå› **ï¼šç£ç›˜I/Oæ€§èƒ½æˆ–ç½‘ç»œå»¶è¿Ÿ
**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥æ–‡ä»¶å­˜å‚¨ä½ç½®
- è€ƒè™‘ä½¿ç”¨SSDå­˜å‚¨
- ä¼˜åŒ–æ–‡ä»¶ç³»ç»Ÿæ€§èƒ½

#### 2. å†…å­˜ä½¿ç”¨è¿‡é«˜
**ç—‡çŠ¶**ï¼šç³»ç»Ÿå†…å­˜å ç”¨æŒç»­å¢é•¿
**åŸå› **ï¼šå¤§é‡å°æ–‡ä»¶åŒæ—¶åŠ è½½
**è§£å†³æ–¹æ¡ˆ**ï¼š
- å®æ–½æ–‡ä»¶åŠ è½½é˜Ÿåˆ—
- è®¾ç½®å†…å­˜ä½¿ç”¨ä¸Šé™
- å¯ç”¨åƒåœ¾å›æ”¶æœºåˆ¶

#### 3. WebViewæ•°æ®ä¼ è¾“å¤±è´¥
**ç—‡çŠ¶**ï¼šæ—¥å¿—æ•°æ®æ˜¾ç¤ºå¼‚å¸¸
**åŸå› **ï¼špostMessageé€šä¿¡ä¸­æ–­
**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥WebViewçŠ¶æ€
- éªŒè¯æ¶ˆæ¯æ ¼å¼
- é‡æ–°åˆå§‹åŒ–è¿æ¥

### è°ƒè¯•æŠ€å·§

#### å¯ç”¨è¯¦ç»†æ—¥å¿—
```typescript
console.log('ğŸ“¤ å‰ç«¯å‘é€è¿‡æ»¤è¯·æ±‚ - çº§åˆ«:', levels);
console.log('ğŸ“¥ åç«¯è¿”å›ç»“æœæ•°é‡:', results.length);
```

#### æ€§èƒ½ç›‘æ§
```typescript
const startTime = performance.now();
// æ‰§è¡ŒåŠ è½½æ“ä½œ
const endTime = performance.now();
console.log(`åŠ è½½è€—æ—¶: ${endTime - startTime}ms`);
```

**èŠ‚æ¥æº**
- [logViewerPanel.ts](file://src/logViewerPanel.ts#L410-L426)

## æ€»ç»“

large_log_checkçš„åˆå§‹åŠ è½½ç­–ç•¥ä½“ç°äº†ä¼˜ç§€çš„è½¯ä»¶è®¾è®¡åŸåˆ™ï¼š

### è®¾è®¡ä¼˜åŠ¿

1. **æ™ºèƒ½å†³ç­–**ï¼šåŸºäºæ–‡ä»¶å¤§å°è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜åŠ è½½ç­–ç•¥
2. **ç”¨æˆ·ä½“éªŒ**ï¼šæä¾›æ¸…æ™°çš„è¿›åº¦åé¦ˆå’ŒåŠæ—¶çš„æ“ä½œå“åº”
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¹³è¡¡å†…å­˜ä½¿ç”¨å’ŒåŠ è½½é€Ÿåº¦
4. **å¯æ‰©å±•æ€§**ï¼šæ¨¡å—åŒ–è®¾è®¡ä¾¿äºåŠŸèƒ½æ‰©å±•

### æŠ€æœ¯äº®ç‚¹

- **æµå¼å¤„ç†**ï¼šæ”¯æŒä»»æ„å¤§å°çš„æ—¥å¿—æ–‡ä»¶
- **å¼‚æ­¥æ¶æ„**ï¼šéé˜»å¡çš„ç”¨æˆ·ç•Œé¢
- **åŒå‘é€šä¿¡**ï¼šVSCodeä¸WebViewçš„æ— ç¼é›†æˆ
- **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸æ•è·å’Œæ¢å¤æœºåˆ¶

### åº”ç”¨ä»·å€¼

è¯¥ç­–ç•¥ä¸ä»…è§£å†³äº†å¤§æ–‡ä»¶å¤„ç†çš„æŠ€æœ¯éš¾é¢˜ï¼Œæ›´ä¸ºå¼€å‘è€…æä¾›äº†é«˜æ•ˆã€ç¨³å®šçš„æ—¥å¿—åˆ†æå·¥å…·ã€‚é€šè¿‡åˆç†çš„èµ„æºåˆ†é…å’Œç”¨æˆ·ä½“éªŒè®¾è®¡ï¼Œå®ç°äº†æŠ€æœ¯æ€§èƒ½ä¸ç”¨æˆ·æ»¡æ„åº¦çš„æœ€ä½³å¹³è¡¡ã€‚