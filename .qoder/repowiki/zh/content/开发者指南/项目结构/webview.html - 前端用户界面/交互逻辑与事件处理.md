# 交互逻辑与事件处理

<cite>
**本文档引用的文件**
- [src/webview.html](file://src/webview.html)
- [src/extension.ts](file://src/extension.ts)
- [src/logViewerPanel.ts](file://src/logViewerPanel.ts)
- [package.json](file://package.json)
</cite>

## 目录
1. [概述](#概述)
2. [VSCode扩展通信机制](#vscode扩展通信机制)
3. [核心事件处理函数](#核心事件处理函数)
4. [右键菜单系统](#右键菜单系统)
5. [模态框交互](#模态框交互)
6. [时间线画布交互](#时间线画布交互)
7. [事件委托与防抖处理](#事件委托与防抖处理)
8. [错误反馈机制](#错误反馈机制)
9. [性能优化实践](#性能优化实践)

## 概述

该日志查看器扩展通过WebView技术实现了丰富的交互功能，前端JavaScript通过`acquireVsCodeApi()`与VSCode扩展后端建立双向通信通道。系统采用事件驱动架构，支持搜索、过滤、分页、删除等核心操作，同时提供了完善的用户界面反馈和错误处理机制。

## VSCode扩展通信机制

### 通信架构

系统采用消息传递模式实现前端与后端的通信：

```mermaid
sequenceDiagram
participant Frontend as "前端JavaScript"
participant VsCodeAPI as "acquireVsCodeApi()"
participant Extension as "扩展后端"
participant LogProcessor as "日志处理器"
Frontend->>VsCodeAPI : postMessage({command, data})
VsCodeAPI->>Extension : 转发消息
Extension->>LogProcessor : 处理业务逻辑
LogProcessor-->>Extension : 返回结果
Extension->>VsCodeAPI : postMessage({command, data})
VsCodeAPI-->>Frontend : onDidReceiveMessage回调
```

**图表来源**
- [src/webview.html](file://src/webview.html#L1212-L1262)
- [src/logViewerPanel.ts](file://src/logViewerPanel.ts#L53-L98)

### 关键通信流程

前端通过`acquireVsCodeApi()`获取通信接口，后端监听消息并执行相应操作：

**章节来源**
- [src/webview.html](file://src/webview.html#L1212-L1214)
- [src/logViewerPanel.ts](file://src/logViewerPanel.ts#L53-L98)

## 核心事件处理函数

### 搜索功能 (`search()`)

搜索功能支持关键词搜索和正则表达式搜索：

```mermaid
flowchart TD
Start([用户点击搜索]) --> GetParams["获取搜索参数<br/>keyword, regexMode, reverse"]
GetParams --> ValidateInput{"验证输入"}
ValidateInput --> |空输入| Refresh["刷新显示所有数据"]
ValidateInput --> |有效输入| CheckMode{"检查搜索模式"}
CheckMode --> |正则| RegexSearch["发送正则搜索请求"]
CheckMode --> |普通| TextSearch["发送文本搜索请求"]
RegexSearch --> PostMessage["postMessage({command: 'regexSearch'})"]
TextSearch --> PostMessage
PostMessage --> Backend["扩展后端处理"]
Backend --> Results["返回搜索结果"]
Results --> Render["渲染搜索结果"]
```

**图表来源**
- [src/webview.html](file://src/webview.html#L1951-L1985)

**章节来源**
- [src/webview.html](file://src/webview.html#L1951-L1985)

### 过滤功能 (`applyFilter()`)

过滤功能支持按日志级别进行多选过滤：

```mermaid
flowchart TD
FilterClick([点击过滤]) --> CollectLevels["收集选中的日志级别"]
CollectLevels --> CheckAll{"检查全选状态"}
CheckAll --> |全部选中| Refresh["发送刷新请求"]
CheckAll --> |部分选中| SendFilter["发送过滤请求"]
CheckAll --> |全部未选中| ShowEmpty["显示空结果"]
SendFilter --> PostMessage["postMessage({command: 'filterByLevel'})"]
PostMessage --> Backend["扩展后端处理"]
Backend --> FilterResults["返回过滤结果"]
FilterResults --> UpdateUI["更新界面显示"]
```

**图表来源**
- [src/webview.html](file://src/webview.html#L1987-L2043)

**章节来源**
- [src/webview.html](file://src/webview.html#L1987-L2043)

### 分页控制 (`goToPage()`)

分页功能支持智能计算和动态加载：

```mermaid
flowchart TD
PageChange([翻页操作]) --> CheckMode{"检查折叠模式"}
CheckMode --> |折叠模式| CalcRange["计算页面范围"]
CheckMode --> |非折叠模式| StandardCalc["标准分页计算"]
CalcRange --> CheckCached{"检查缓存范围"}
CheckCached --> |已缓存| UseCache["使用缓存范围"]
CheckCached --> |未缓存| AsyncCalc["异步计算页面"]
StandardCalc --> UpdatePagination["更新分页显示"]
UseCache --> UpdatePagination
AsyncCalc --> UpdatePagination
UpdatePagination --> RenderLines["渲染日志行"]
```

**图表来源**
- [src/webview.html](file://src/webview.html#L3476-L3528)

**章节来源**
- [src/webview.html](file://src/webview.html#L3476-L3528)

## 右键菜单系统

### 菜单架构

右键菜单采用事件委托模式，支持多种操作：

```mermaid
classDiagram
class ContextMenu {
+showContextMenu(event, content, lineNumber)
+closeContextMenu()
+copyToClipboard(text)
+toggleBookmark(lineNumber)
+addOrEditComment(lineNumber)
+jumpToLine(lineNumber)
}
class MenuItem {
+string icon
+string label
+function handler
+boolean separator
}
class MenuBuilder {
+buildCopyMenu()
+buildBookmarkMenu()
+buildCommentMenu()
+buildNavigationMenu()
}
ContextMenu --> MenuItem : creates
ContextMenu --> MenuBuilder : uses
MenuItem --> MenuBuilder : configured_by
```

**图表来源**
- [src/webview.html](file://src/webview.html#L2526-L2657)

### 菜单项功能

右键菜单提供以下功能：
- 复制选中内容/整行
- 添加/移除书签
- 添加/编辑/删除注释
- 定位到指定行
- 搜索相关日志

**章节来源**
- [src/webview.html](file://src/webview.html#L2526-L2657)

## 模态框交互

### 模态框管理系统

系统采用统一的模态框管理机制：

```mermaid
stateDiagram-v2
[*] --> Hidden
Hidden --> Showing : showXXXModal()
Showing --> Visible : 显示动画完成
Visible --> Hiding : closeXXXModal()
Hiding --> Hidden : 隐藏动画完成
Visible --> Visible : 用户交互
Showing --> Hidden : 用户取消
Hiding --> Showing : 错误重试
```

**图表来源**
- [src/webview.html](file://src/webview.html#L823-L1210)

### 主要模态框功能

| 模态框类型 | 功能描述 | 关键操作 |
|-----------|----------|----------|
| 统计信息 | 显示日志统计和分析结果 | 查看各类统计数据、按类别筛选 |
| 删除操作 | 按时间和行数删除日志 | 选择删除方式、确认删除操作 |
| 快速定位 | 按行号或时间跳转 | 输入目标位置、执行跳转 |
| 书签管理 | 管理书签列表 | 添加/删除书签、批量操作 |
| 注释管理 | 管理日志注释 | 添加/编辑/删除注释 |
| 高亮规则 | 自定义高亮规则 | 添加/编辑/删除高亮规则 |

**章节来源**
- [src/webview.html](file://src/webview.html#L823-L1210)

## 时间线画布交互

### 时间线功能架构

时间线画布提供可视化的时间分布分析：

```mermaid
flowchart TD
GenerateTimeline([生成时间线]) --> ExtractTimestamps["提取时间戳"]
ExtractTimestamps --> CheckData{"检查数据有效性"}
CheckData --> |无时间戳| HideTimeline["隐藏时间线"]
CheckData --> |有效数据| CalculateRange["计算时间范围"]
CalculateRange --> CreateBuckets["创建时间桶"]
CreateBuckets --> CountLogs["统计日志数量"]
CountLogs --> DrawCanvas["绘制时间线"]
DrawCanvas --> AddInteractions["添加交互事件"]
AddInteractions --> TimelineReady["时间线就绪"]
```

**图表来源**
- [src/webview.html](file://src/webview.html#L2769-L2934)

### 交互功能

时间线画布支持以下交互：
- 点击跳转到对应时间段
- 鼠标悬停显示详细信息
- 时间范围缩放
- 级别颜色区分

**章节来源**
- [src/webview.html](file://src/webview.html#L2769-L2934)

## 事件委托与防抖处理

### 事件委托模式

系统广泛使用事件委托减少内存占用：

```javascript
// 事件委托示例
document.getElementById('logContainer').addEventListener('click', function(e) {
    if (e.target.classList.contains('log-line')) {
        handleLineClick(e);
    }
});
```

### 防抖处理机制

对于频繁触发的操作，系统实现了防抖处理：

```javascript
// 搜索防抖
let searchTimeout;
function debouncedSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        search();
    }, 300);
}
```

**章节来源**
- [src/webview.html](file://src/webview.html#L3775-L3780)

## 错误反馈机制

### 多层次错误处理

系统实现了多层次的错误反馈机制：

```mermaid
flowchart TD
Error([错误发生]) --> CatchError["捕获错误"]
CatchError --> CheckType{"检查错误类型"}
CheckType --> |网络错误| NetworkError["网络错误提示"]
CheckType --> |业务错误| BusinessError["业务错误提示"]
CheckType --> |系统错误| SystemError["系统错误提示"]
NetworkError --> ShowToast["显示Toast通知"]
BusinessError --> ShowAlert["显示Alert对话框"]
SystemError --> ShowErrorLog["记录错误日志"]
ShowToast --> UserAction["用户采取行动"]
ShowAlert --> UserAction
ShowErrorLog --> Debugging["调试分析"]
```

**图表来源**
- [src/webview.html](file://src/webview.html#L2499-L2521)

### 错误类型处理

| 错误类型 | 处理方式 | 用户反馈 |
|---------|----------|----------|
| 网络连接失败 | 重试机制 | Toast提示"网络连接失败" |
| 文件加载超时 | 超时重试 | Alert提示"加载超时，请重试" |
| 搜索语法错误 | 实时验证 | 即时反馈"正则表达式错误" |
| 删除操作确认 | 确认对话框 | Modal确认窗口 |
| 数据解析错误 | 优雅降级 | 显示原始数据 |

**章节来源**
- [src/webview.html](file://src/webview.html#L2499-L2521)

## 性能优化实践

### 虚拟滚动优化

对于大量日志数据，系统实现了虚拟滚动：

```javascript
// 虚拟滚动核心逻辑
function renderLines() {
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, allLines.length);
    const visibleLines = allLines.slice(startIndex, endIndex);
    
    // 只渲染可见区域的行
    visibleLines.forEach(renderSingleLine);
}
```

### 数据缓存策略

系统采用多级缓存策略提升性能：

```mermaid
graph TD
A[原始数据] --> B[内存缓存]
B --> C[页面范围缓存]
C --> D[DOM缓存]
D --> E[渲染结果]
F[用户操作] --> G[缓存失效]
G --> A
```

**图表来源**
- [src/webview.html](file://src/webview.html#L1224-L1226)

### 异步处理优化

对于耗时操作，系统采用异步处理：

```javascript
// 异步计算页面范围
async function calculateAllPagesAsync() {
    // 分批处理，避免阻塞主线程
    for (let i = 0; i < batchCount; i++) {
        await processBatch();
        updateProgress();
    }
}
```

**章节来源**
- [src/webview.html](file://src/webview.html#L1534-L1588)

## 总结

该日志查看器扩展通过精心设计的交互逻辑和事件处理机制，实现了流畅的用户体验。系统采用了现代Web开发的最佳实践，包括事件委托、防抖处理、异步操作、错误处理等技术，确保了良好的性能和稳定性。通过VSCode扩展通信机制，实现了前后端的无缝协作，为用户提供了强大的日志分析工具。